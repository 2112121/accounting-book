// The exported code uses Tailwind CSS. Install Tailwind CSS in your dev environment to ensure all styles work.
import React, { useState, useEffect, useRef, useCallback } from "react";
import * as echarts from "echarts";
import ExpenseForm from "./components/ExpenseForm";
import LoginForm from "./components/LoginForm";
import ProfileForm from "./components/ProfileForm";
import { useAuth } from "./contexts/AuthContext";
import {
  collection,
  getDocs,
  addDoc,
  query,
  where,
  doc,
  deleteDoc,
  updateDoc,
  orderBy,
  setDoc,
  limit,
  serverTimestamp,
  Timestamp,
  getDoc,
  onSnapshot,
} from "firebase/firestore";
import { db } from "./firebase";
import DatePicker from "react-datepicker";
import "react-datepicker/dist/react-datepicker.css";
import LeaderboardForm from "./components/LeaderboardForm";
import FriendManagement from "./components/FriendManagement";
import { format, isSameDay, subDays, startOfMonth, endOfMonth } from 'date-fns';
import LeaderboardInviteList from "./components/LeaderboardInviteList";
import { auth } from "./firebase";
import LeaderboardViewer from "./components/LeaderboardViewer";
import LeaderboardNotification from "./components/LeaderboardNotification";
import LoanManagement from "./components/LoanManagement"; // å¼•å…¥?Ÿè²¸ç®¡ç?çµ„ä»¶
import BudgetSetting from './components/BudgetSetting';
import BudgetNotification from './components/BudgetNotification';
// å¼•å…¥SplitExpenseManagementçµ„ä»¶

// ?¯å‡ºé¡å?å®šç¾©
interface Expense {
  id: string;
  amount: number;
  category: {
    id: string;
    name: string;
  icon: string;
  };
  date: Date;
    notes: string;
  userId: string;
}

const App: React.FC = () => {
  const [showExpenseForm, setShowExpenseForm] = useState(false);
  const [showLoginForm, setShowLoginForm] = useState(false);
  const [showSuccessMessage, setShowSuccessMessage] = useState(false);
  const [showSidebar, setShowSidebar] = useState(false);
  const [showProfileForm, setShowProfileForm] = useState(false);
  const [showLeaderboardForm, setShowLeaderboardForm] = useState(false);
  const [showFriendManagement, setShowFriendManagement] = useState(false);
  const [showNotifications, setShowNotifications] = useState(false);
  const [showLeaderboardInvites, setShowLeaderboardInvites] = useState(false);
  const [showLeaderboardViewer, setShowLeaderboardViewer] = useState(false);
  const [notificationCount, setNotificationCount] = useState(0);
  const [leaderboardEndedNotifications, setLeaderboardEndedNotifications] =
    useState<any[]>([]);
  // æ·»å??Ÿè²¸?°æ??šçŸ¥?€??  const [loanDueNotifications, setLoanDueNotifications] = useState<any[]>([]);
  const [loanOverdueNotifications, setLoanOverdueNotifications] = useState<any[]>([]);
  const [editingExpense, setEditingExpense] = useState<Expense | null>(null); // æ­?œ¨ç·¨è¼¯?„æ”¯??  const [successMessage, setSuccessMessage] = useState("è¨˜å¸³?å?ï¼?); // ?ªå?ç¾©æ??Ÿè???  const [selectedCategory, setSelectedCategory] = useState<string | null>(null); // ?¸ä¸­?„æ”¯?ºé???const chartRef = useRef<HTMLDivElement>(null);
  const dailyChartRef = useRef<HTMLDivElement>(null);
  const {
    currentUser,
    login,
    logout,
    register,
    userNickname,
    getFriendRequests,
    getLeaderboardInvites,
  } = useAuth();
  const [expenses, setExpenses] = useState<Expense[]>([]);
  const [totalExpense, setTotalExpense] = useState(0);
  const [todayExpense, setTodayExpense] = useState(0);
  const [error, setError] = useState<string | null>(null);
  // ?¨æ–¼å­˜å„²?¨æˆ¶?¸æ?ç·©å??„å?è±?  const [userDataCache, setUserDataCache] = useState<Record<string, Expense[]>>(
    {},
  );
  // ?¨æ–¼æ¨™è??¯å¦?•æ–¼?¸æ??¢å¾©æ¨¡å?
  const [isRecoveryMode, setIsRecoveryMode] = useState<boolean>(false);
  // ?¨æ–¼æ¨™è??¯å¦?¯ç€è¦½?¨åˆ·?°å?è¼‰ç?æ¨™è?
  const [isBrowserRefresh, setIsBrowserRefresh] = useState<boolean>(false);
  // æ·»å?è¨ˆæ??¨å??¨ï??¨æ–¼ç®¡ç??å?è¨Šæ¯?„é¡¯ç¤?  const successMessageTimer = useRef<number | undefined>(undefined);
  // æ·»å??¸å??„æ—¥?Ÿç??‹ï?é»˜è??ºä?å¤?  const [selectedDate, setSelectedDate] = useState<Date>(new Date());
  // ?¥æ??¸é?
  const dateOptions = [
    { value: new Date().toISOString().slice(0, 10), label: "ä»Šæ—¥" },
    {
      value: new Date(Date.now() - 86400000).toISOString().slice(0, 10),
      label: "?¨æ—¥",
    },
    { value: "earlier", label: "?´æ—©" },
    { value: "all", label: "?¨éƒ¨" },
  ];
  // æ·»å??¸æ??„æ—¥?Ÿé¸?…ï??€??ä»Šæ—¥"ï¼??¨æ—¥"ï¼??´æ—©"ï¼??¨éƒ¨"
  const [selectedDateOption, setSelectedDateOption] = useState<
    "today" | "yesterday" | "this_week" | "last_week" | "earlier" | "all" | "month" | "month_select"
  >("today");
  const [showDatePicker, setShowDatePicker] = useState(false);
  const [showMonthPicker, setShowMonthPicker] = useState(false);
  const [selectedMonth, setSelectedMonth] = useState<string>(
    new Date().toISOString().slice(0, 7) // ?¼å???"YYYY-MM"
  );
  const [showMobileForm, setShowMobileForm] = useState(false);
  const [showPasswordForm, setShowPasswordForm] = useState(false);
  const [friendRequestCount, setFriendRequestCount] = useState(0);
  const [leaderboardInviteCount, setLeaderboardInviteCount] = useState(0);
  const [loginFormMode, setLoginFormMode] = useState<"login" | "register">(
    "login",
  );

  // å®???–è¡¨å¯¦ä?è®Šæ•¸ä»¥ä??¨å?ä½¿ç”¨
  const [chartInstance, setChartInstance] = useState<echarts.ECharts | null>(
    null,
  );
  const [dailyChartInstance, setDailyChartInstance] =
    useState<echarts.ECharts | null>(null);

  const [chartsKey, setChartsKey] = useState(0);
  // æ·»å??–ä??¸æ??€?‹ç®¡??  const [legendSelectedMap, setLegendSelectedMap] = useState<
    Record<string, boolean>
  >({});

  const [navScrolled, setNavScrolled] = useState(false);
    
    // ??½æ»¾å?äº‹ä»¶ï¼Œå¯¦?¾å??ªæ?æ»¾å?è®Šå??ˆæ?
  useEffect(() => {
      const handleScroll = () => {
        if (window.scrollY > 20) {
          setNavScrolled(true);
    } else {
          setNavScrolled(false);
        }
      };
      
      window.addEventListener('scroll', handleScroll);
      
      return () => {
        window.removeEventListener('scroll', handleScroll);
      };
    }, []);

  // å¾¹å??å¯«?¥æ??•ç??½æ•¸ - ä½¿ç”¨?€?Ÿå??¹å?ç¢ºä??²å??¶å??¥æ?
  const getTodayDate = () => {
    // ?´æ¥?µå»ºä¸€?‹å…¨?°ç??¥æ?å°è±¡ï¼Œä??¨ç·©å­˜ï?ç¢ºä?æ¯æ¬¡?½ç²?–æ??°æ???    const now = new Date();
    // ?´æ¥?ç½®?‚é??ºç•¶å¤?é»???ç§’ï?ä¿ç??Ÿå??‚å?ä¿¡æ¯
    now.setHours(0, 0, 0, 0);
    // è¼¸å‡ºå®Œæ•´?¥æ?ä¿¡æ¯?¨æ–¼èª¿è©¦
    console.log("===?²å?ä»Šæ—¥?¥æ?===", {
      ?¥æ?å°è±¡: now.toString(),
      ISO?¼å?: now.toISOString(),
      ?¬åœ°?¥æ?: now.toLocaleDateString("zh-TW"),
      ?‚é??? now.getTime(),
      å¹? now.getFullYear(),
      ?? now.getMonth() + 1,
      ?? now.getDate(),
    });
    return now;
  };

  // ?¨æ??¨å??•æ?å¼·åˆ¶?´æ–°?¶å??¥æ?
  useEffect(() => {
    console.log("?‰ç”¨?Ÿå?ï¼Œå¼·?¶æ›´?°ç•¶?æ—¥??);
    // å¼·åˆ¶?²å??€?°ç??¶å??¥æ?
    const freshToday = getTodayDate();
    console.log("?‰ç”¨?Ÿå?ä½¿ç”¨?„ä??¥æ—¥??", freshToday.toISOString());
    setSelectedDate(freshToday);
    setSelectedDateOption("today");
  }, []);

  // ??½?’è?æ¦œç€è¦½?¨é¡¯ç¤ºä?ä»?  useEffect(() => {
    const handleShowLeaderboardViewer = () => {
      console.log("?¥æ”¶?°é¡¯ç¤ºæ?è¡Œæ??è¦½?é¢äº‹ä»¶");
      // ?œé??’è?æ¦œç®¡?†é???      setShowLeaderboardForm(false);
      // é¡¯ç¤º?’è?æ¦œç€è¦½?é¢
      setShowLeaderboardViewer(true);
    };

    // æ·»å?äº‹ä»¶??½??    window.addEventListener(
      "showLeaderboardViewer",
      handleShowLeaderboardViewer,
    );

    // æ¸…ç??½æ•¸
    return () => {
      window.removeEventListener(
        "showLeaderboardViewer",
        handleShowLeaderboardViewer,
      );
    };
  }, []);

  // æ¯ç•¶selectedDateOptionè®Šå??‚æ›´?°å¯¦?›æ—¥??  useEffect(() => {
    console.log("?¥æ??¸é?è®Šæ›´:", selectedDateOption);
    if (selectedDateOption === "today") {
      // å¼·åˆ¶?²å??€?°ç?ä»Šå¤©?¥æ?
      const currentToday = getTodayDate();
      console.log("?´æ–°?ºä?å¤©æ—¥??", currentToday.toISOString());
      setSelectedDate(currentToday);
    } else if (selectedDateOption === "yesterday") {
      // è¨ˆç??¨å¤©?¥æ?
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      yesterday.setHours(0, 0, 0, 0);
      console.log("?´æ–°?ºæ˜¨å¤©æ—¥??", yesterday.toISOString());
      setSelectedDate(yesterday);
    }
  }, [selectedDateOption]);

  // ?“é??–å?å§‹å??½æ•¸ - ç§»åˆ°useEffectå¤–éƒ¨
  const createEmptyPieChart = () => {
    console.log("?µå»ºç©ºå?é¤…å? - ä¸é¡¯ç¤ºæš«?¡æ•¸?šæ?ç¤?);

    if (!chartRef.current) {
      console.error("?“é??–DOM?ƒç?ä¸å???);
      return;
    }

    try {
      // æ¸…é™¤?Šå¯¦ä¾?      if (chartInstance) {
        try {
          chartInstance.dispose();
        } catch (e) {
          console.error("æ¸…é™¤?“é??–å¯¦ä¾‹æ??ºéŒ¯:", e);
        }
      }

      // ?µå»ºä¸€?‹åŸº?¬ç?ç©ºå?è¡¨ï?ä½†ä?å¸??«ç„¡?¸æ?"?ç¤º
      const chart = echarts.init(chartRef.current);

      const option = {
        title: null,
        tooltip: {
          trigger: "item",
        },
        legend: {
          // ç¢ºä??–ä?å§‹ç?é¡¯ç¤º?¨å??¨ä¸­å¿ƒï?ä¸¦è¨­ç½®é©?¶ç??“è?
          orient: "horizontal",
          left: "center",
          bottom: 10,
          padding: [0, 0, 0, 0], // æ¸›å??§é?è·ä»¥?²æ­¢è·‘ç?
          textStyle: {
            color: "#6E6E6E",
          },
          itemGap: 20, // å¢å??…ç›®?“è?
          formatter: function (name: string) {
            // ç¸®çŸ­?–ä??‡å?ï¼Œç¢ºä¿ä?å±€ä¸€??            if (name.length > 4) {
              return name.substring(0, 4) + "...";
            }
            return name;
          },
        },
        color: [
          "#A487C3", // ç´«è‰²
          "#FAC6CD", // ç²‰è‰²
          "#B8E3C9", // ç¶ è‰²
          "#FFD166", // é»ƒè‰²
          "#4EA8DE", // ?è‰²
          "#FF8B64", // æ©™è‰²
          "#C0C6E8", // æ·ºè?ç´«è‰²
          "#9CC3D5", // å¤©è???          "#FFB3B3", // æ·ºç???          "#D8BBFF", // æ·ºç´«??        ],
        // æ·»å?ç°¡å??„å??«è¨­ç½?        animation: true,
        animationDuration: 700,
        animationEasing: 'sinusoidalOut' as const,
        series: [
          {
            name: "?¯å‡º?‘é?",
            type: "pie",
            radius: ["30%", "60%"], // ?Ÿå???["40%", "70%"]ï¼Œç¸®å°æ?ä¾?            center: ["50%", "45%"], // å¾?40%"?¹ç‚º"45%"ï¼Œå?ä¸‹ç§»??            data: [],
            label: {
              show: false,
            },
            emphasis: {
              disabled: true,
            },
          },
        ],
      };

      chart.setOption(option);
      setChartInstance(chart);
    } catch (e) {
      console.error("?µå»ºç©ºå?é¤…å??‚å‡º??", e);
    }
  };

  // ç°¡å??“é??–å?å§‹å?æµç?ï¼Œç¢ºä¿å?è¡¨èƒ½å¤ é¡¯ç¤?  const initPieChart = () => {
    console.log("?å??–å?é¤…å? - ?‹å?æª¢æŸ¥?¸æ?");

    if (!chartRef.current) {
      console.error("?“é??–DOM?ƒç?ä¸å???);
      return;
    }

    // æª¢æŸ¥?¯å¦?‰æ•¸??    if (!expenses || expenses.length === 0) {
      console.log("æ²’æ??¯å‡º?¸æ?ï¼Œé¡¯ç¤ºç©º?“é???);
      createEmptyPieChart();
      return;
    }

    // ?ˆæ??¤è??„å¯¦ä¾?    if (chartInstance) {
      try {
        chartInstance.dispose();
      } catch (e) {
        console.error("æ¸…é™¤?“é??–å¯¦ä¾‹æ??ºéŒ¯:", e);
      }
    }

    // ?µå»º?°å¯¦ä¾?    try {
      console.log("?‹å??å??–å?é¤…å?ï¼Œæ•¸?šç???", expenses.length);
      const chart = echarts.init(chartRef.current);

      // è¨ˆç??†é??¯å‡º
      const categorySum: Record<string, number> = {};
      let totalAmount = 0;

      expenses.forEach((expense) => {
        // ?•ç? category ?¯èƒ½?¯å?ç¬¦ä¸²?–å?è±¡ç??…æ?
        const categoryName =
          typeof expense.category === "string"
            ? expense.category
            : expense.category?.name || "?ªå?é¡?;

        // ç¢ºä??‘é??¯æ??ˆæ•¸å­?        const amount = typeof expense.amount === "number" ? expense.amount : 0;

        // ?¹ç‚º?¥å?ä»»ä??¸å€¼ï?ä¸å?æª¢æŸ¥?¯å¦>0ï¼Œåªè¦æ˜¯?¸å€¼å°±ç´¯å?
        totalAmount += amount;

        if (categorySum[categoryName]) {
          categorySum[categoryName] += amount;
    } else {
          categorySum[categoryName] = amount;
        }
      });

      console.log("è¨ˆç??„å?é¡æ”¯??", categorySum, "ç¸½é?é¡?", totalAmount);

      // ç¢ºè??¯å¦?‰æ•¸??- ?ªè??‰å?é¡æ•¸?šå°±é¡¯ç¤º?–è¡¨
      const hasData = Object.keys(categorySum).length > 0;

      // å¦‚æ?æ²’æ??¸æ?ï¼Œé¡¯ç¤ºç©º?–è¡¨
      if (!hasData) {
        console.log("?“é??–æ??‰æ??ˆæ•¸?šï?é¡¯ç¤ºç©ºå?è¡?);
        createEmptyPieChart();
        return;
      }

      // æº–å??–è¡¨?¸æ?
      const pieData = Object.keys(categorySum).map((category) => ({
        name: category,
        value: categorySum[category],
      }));

      console.log("æº–å??„å?é¤…å??¸æ?:", pieData);

      // è¨­ç½®?–è¡¨?¸é?
      const isMobile = window.innerWidth < 768; // æª¢æ¸¬?¯å¦?ºç§»?•è¨­??
      // ?¶å??¯å¦?¸ä¸­?å€‹é???      const isSelectedMode = selectedCategory !== null;

      // æ¨™æ??“é??–é?ç½?      const option = {
        // ç¢ºä?æ²’æ?æ¨™é?
        title: null,
        tooltip: {
          trigger: "item",
          formatter: "{a} <br/>{b}: NT${c} ({d}%)",
          confine: true,
        },
        legend: {
          // ?¶é¸ä¸­é??¥æ?ï¼Œéš±?å?ä¾?          show: !isSelectedMode,
          orient: "horizontal",
          left: "center",
          bottom: 0,
          padding: [20, 0, 0, 0],
          itemWidth: 14,
          itemHeight: 14,
          itemGap: 20, // å¢å??…ç›®?“è?ä»¥é˜²æ­¢é???          formatter: function (name: string) {
            // å°é•·?‡å??²è?ç¸®çŸ­?•ç?
            if (name.length > 4) {
              return name.substring(0, 4) + "...";
            }
            return name;
          },
          data: Object.keys(categorySum),
          textStyle: {
            color: "#6E6E6E",
            fontSize: 12, // ç¢ºä??‡å?å¤§å??©ç•¶
          },
          // ä½¿ç”¨React?€?‹ä¸­?„å?ä¾‹é¸?‡ç???          selected: legendSelectedMap,
        },
        color: [
          "#A487C3", // ç´«è‰²
          "#FAC6CD", // ç²‰è‰²
          "#B8E3C9", // ç¶ è‰²
          "#FFD166", // é»ƒè‰²
          "#4EA8DE", // ?è‰²
          "#FF8B64", // æ©™è‰²
          "#C0C6E8", // æ·ºè?ç´«è‰²
          "#9CC3D5", // å¤©è???          "#FFB3B3", // æ·ºç???          "#D8BBFF", // æ·ºç´«??        ],
        // æ·»å??¨å??•ç•«è¨­ç½®
        animation: true,
        animationThreshold: 1000, 
        animationDuration: 700,
        animationEasing: 'sinusoidalOut' as const,
        animationDelay: 0,
        animationDurationUpdate: 400,
        animationEasingUpdate: 'linear' as const,
        animationDelayUpdate: 0,
        series: [
          {
            name: "?¯å‡º?‘é?",
            type: "pie",
            radius: ["30%", "60%"], // ?Ÿå???["40%", "70%"]ï¼Œç¸®å°æ?ä¾?            // å°‡y?æ?å¾?0%èª¿æ•´??0%ï¼Œå?ä¸Šç§»??            center: [
              isSelectedMode ? (isMobile ? "48%" : "45%") : "50%",
              "45%", // å¾?40%"?¹ç‚º"45%"ï¼Œå?ä¸‹ç§»??            ],
            avoidLabelOverlap: false,
            emphasis: {
              itemStyle: {
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowColor: "rgba(0, 0, 0, 0.2)",
              },
              scale: true,
              scaleSize: 10
            },
            label: {
              show: true,
              formatter: "{b}\n{d}%",
            },
            labelLine: {
              show: true,
              smooth: true,
              length: 15,
              length2: 12
            },
            data: pieData,
            // ç°¡å?é¤…å??•ç•«è¨­ç½®
            animationType: 'expansion' as const,
            animationEasing: 'sinusoidalOut' as const,
            animationDelay: function (idx: number) {
              return idx * 60;
            }
          },
        ],
      };

      // ?ç¢ºç§»é™¤graphicå±¬æ€§ï?ç¢ºä?ä¸æ?é¡¯ç¤º"?«ç„¡?¸æ?"
      console.log("è¨­ç½®?“é??–é¸?…ï??¸æ??…æ•¸??", pieData.length);
      chart.setOption(option);

      // æ·»å??–ä??¸æ?è®Šå?äº‹ä»¶
      chart.on("legendselectchanged", function (params: any) {
        console.log("?–ä??¸æ?è®Šæ›´:", params);
        // ?´æ–°React?€?‹ä¸­?„å?ä¾‹é¸??        setLegendSelectedMap(params.selected);
      });

      // é»æ?äº‹ä»¶?•ç?
      chart.on("click", function (params) {
        if (params.componentType === "series") {
          console.log("é»æ??“é??–å?é¡?", params.name);
          setSelectedCategory(params.name);

          // é»æ?å¾Œï??æ–°è¨­ç½®?–è¡¨ï¼Œç¢ºä¿æ?é¡Œä?é¡¯ç¤ºä¸¦èª¿?´å?è¡¨ä?ç½?          chart.setOption({
            title: null,
            legend: {
              show: false,
              // ä¿ç??–ä??¸æ??€??              selected: legendSelectedMap,
            },
            series: [
              {
                center: [isMobile ? "48%" : "45%", "50%"],
              },
            ],
          });
        }
      });

      // è¨­ç½®å¯¦ä?å¾Œå?ä¿å?
      setChartInstance(chart);
      console.log("?“é??–å?å§‹å?å®Œæ?");
    } catch (e) {
      console.error("?µå»º?“é??–æ??ºéŒ¯:", e);
      // ?ºéŒ¯?‚é¡¯ç¤ºç©º?–è¡¨
      createEmptyPieChart();
    }
  };

  // ä¿®æ”¹?ç½®?½æ•¸ï¼Œç¢ºä¿å?è¡¨é?ç½®æ?ä¿ç??–ä??¸æ??€??  const resetCategorySelection = () => {
    console.log("?ç½®é¡åˆ¥?¸æ? - ?‹å?", legendSelectedMap);

    // ?´æ–°?€??    setSelectedCategory(null);

    // å¦‚æ??‰å?è¡¨å¯¦ä¾‹ï?èª¿æ•´å®ƒç?ä½ç½®?Œå?ä¾‹ï?ä½†ä??æ–°?å???    if (chartInstance) {
      try {
        // ?´æ–°?–è¡¨?¸é?ï¼Œä??™å?ä¾‹é¸?‡ç??‹ï?ä¸é?è¦é??°å?å§‹å?
        chartInstance.setOption({
          legend: {
            show: true,
            selected: legendSelectedMap, // ä½¿ç”¨React?€?‹ä¸­ä¿å??„å?ä¾‹é¸??          },
          series: [
            {
              center: ["50%", "50%"],
            },
          ],
        });

        // ç¢ºä??–è¡¨?æ–°æ¸²æ?
      setTimeout(() => {
          chartInstance.resize();
        }, 10);
      } catch (err) {
        console.error("èª¿æ•´?–è¡¨ä½ç½®?ºéŒ¯:", err);
        // ?ªæ??¨å‡º?¯æ??å¼·?¶é??°æ¸²??        setChartsKey((prev) => prev + 1);
      }
    } else {
      // å¦‚æ?æ²’æ??–è¡¨å¯¦ä?ï¼Œå¼·?¶é??°æ¸²??      setChartsKey((prev) => prev + 1);
    }
  };

  // æ¯æ—¥è¶¨å‹¢?–å?å§‹å??½æ•¸ - ç§»åˆ°useEffectå¤–éƒ¨
  const createEmptyDailyChart = () => {
    if (!dailyChartRef.current) {
      console.error("æ¯æ—¥è¶¨å‹¢?–DOM?ƒç?ä¸å???);
      return;
    }

    // ?ˆæ??¤è??„å¯¦ä¾?    if (dailyChartInstance) {
      try {
        dailyChartInstance.dispose();
      } catch (e) {
        console.error("æ¸…é™¤æ¯æ—¥è¶¨å‹¢?–å¯¦ä¾‹æ??ºéŒ¯:", e);
      }
    }

    // ?µå»º?°å¯¦ä¾?    try {
      console.log("?µå»ºç©ºæ??¥è¶¨?¢å? - ä¸é¡¯ç¤ºæš«?¡æ•¸?šæ?ç¤?);
      const chart = echarts.init(dailyChartRef.current);

      // è¨­ç½®ç©ºç???- ?¹ç‚ºé¡¯ç¤ºç©ºç™½?–è¡¨?Œé?"?«ç„¡?¸æ?"?‡å?
      chart.setOption({
        // ?ªé™¤æ¨™é??ç½®
        tooltip: {
          trigger: "axis",
          formatter: function (params: any) {
            return `${params[0].axisValue}<br/>?¯å‡º?‘é?: NT$${params[0].data}`;
          },
          confine: true,
        },
        grid: {
          left: "3%",
          right: "4%",
          bottom: "15%",
          containLabel: true,
        },
        xAxis: {
          type: "category",
          data: ["?±ä?", "?±ä?", "?±ä?", "?±å?", "?±ä?", "?±å…­", "?±æ—¥"],
          axisLine: { lineStyle: { color: "#999" } }, // é¡è‰²èª¿æ·¡ï¼Œå? #666 ??#999
          axisLabel: {
            color: "#666", // é¡è‰²èª¿æ·¡ï¼Œå? #2E2E2E ??#666
          },
        },
        yAxis: {
          type: "value",
          axisLine: { lineStyle: { color: "#999" } }, // é¡è‰²èª¿æ·¡ï¼Œå? #666 ??#999
          axisLabel: {
            formatter: "{value} ??,
            color: "#666", // é¡è‰²èª¿æ·¡ï¼Œå? #2E2E2E ??#666
          },
        },
        series: [
          {
            name: "æ¯æ—¥?¯å‡º",
            type: "bar",
            data: [0, 0, 0, 0, 0, 0, 0], // é¡¯ç¤ºç©ºæ•¸?šè€Œé??ç¤º?‡å?
            itemStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: "#B8E3C9" },
                { offset: 1, color: "#D4F0DF" },
              ]),
            },
          },
        ],
      });

      // è¨­ç½®å¯¦ä?å¾Œå?ä¿å?
      setDailyChartInstance(chart);
    } catch (e) {
      console.error("?µå»ºç©ºæ??¥è¶¨?¢å??‚å‡º??", e);
    }
  };

  // æ¯æ—¥è¶¨å‹¢?–å?å§‹å??½æ•¸
  const initDailyChart = () => {
    console.log("?å??–æ??¥è¶¨?¢å? - ?‹å?æª¢æŸ¥?¸æ?");

    if (!dailyChartRef.current) {
      console.error("æ¯æ—¥è¶¨å‹¢?–DOM?ƒç?ä¸å???);
      return;
    }

    // æª¢æŸ¥?¯å¦?‰æ•¸??    if (!expenses || expenses.length === 0) {
      console.log("æ²’æ??¯å‡º?¸æ?ï¼Œé¡¯ç¤ºç©ºæ¯æ—¥è¶¨å‹¢??);
      createEmptyDailyChart();
      return;
    }

    // ?ˆæ??¤è??„å¯¦ä¾?    if (dailyChartInstance) {
      try {
        dailyChartInstance.dispose();
      } catch (e) {
        console.error("æ¸…é™¤æ¯æ—¥è¶¨å‹¢?–å¯¦ä¾‹æ??ºéŒ¯:", e);
      }
    }

    // ?µå»º?°å¯¦ä¾?    try {
      console.log("?‹å??å??–æ??¥è¶¨?¢å?ï¼Œæ•¸?šç???", expenses.length);
      const chart = echarts.init(dailyChartRef.current);

      // ?²å??Ÿæ­£?„ä?å¤©æ—¥?Ÿï?ä¸ä½¿?¨ç·©å­˜ç??¥æ?ï¼?      const rightNow = new Date();
      // ?ç½®?‚é???é»???ç§?      rightNow.setHours(0, 0, 0, 0);
      console.log("è¶¨å‹¢?–ä½¿?¨ç?ä»Šå¤©?¥æ?:", rightNow.toISOString());

      // è¨ˆç?æ¯æ—¥?¯å‡º
      const dailySum: Record<string, number> = {};

      // ?²å??€è¿?å¤©ç??¥æ?ï¼ˆå??¬ä?å¤©ï?
      const dates: string[] = [];
      for (let i = 6; i >= 0; i--) {
        // æ¯æ¬¡?µå»º?¨æ–°?¥æ?å°è±¡?¿å?å¼•ç”¨?é?
        const date = new Date();
        // è¨­ç½®??é»?        date.setHours(0, 0, 0, 0);
        // æ¸›å»å°æ?å¤©æ•¸
        date.setDate(date.getDate() - i);
        // ä½¿ç”¨YYYY-MM-DD?¼å?ä½œç‚º??        const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
        dates.push(dateKey);
        dailySum[dateKey] = 0;
      }

      console.log("è¶¨å‹¢?–æ—¥?Ÿç???", dates);

      // è¨ˆç?æ¯å¤©?¯å‡ºç¸½å?
      let hasData = false;
      expenses.forEach((expense) => {
        try {
          // æ¨™æ??–expense?¥æ??ºYYYY-MM-DD?¼å?
          const expenseYear = expense.date.getFullYear();
          const expenseMonth = String(expense.date.getMonth() + 1).padStart(
            2,
            "0",
          );
          const expenseDay = String(expense.date.getDate()).padStart(2, "0");
          const expenseKey = `${expenseYear}-${expenseMonth}-${expenseDay}`;

          if (dailySum[expenseKey] !== undefined) {
            dailySum[expenseKey] += expense.amount;
            console.log(`?¾åˆ°?¥æ? ${expenseKey} ?„æ”¯??`, expense.amount);
            hasData = true;
          }
        } catch (err) {
          console.error("?•ç?expense?¥æ??ºéŒ¯:", err, expense);
        }
      });

      // è¼¸å‡º?¥æ??Œæ”¯?ºè??„ï??¨æ–¼èª¿è©¦
      console.log("æ¯æ—¥?¯å‡ºçµ±è?:", dailySum);

      // æª¢æŸ¥?¯å¦?€?‰æ—¥?Ÿéƒ½æ²’æ??¯å‡º
      if (!hasData) {
        createEmptyDailyChart();
        return;
      }

      // æº–å??¸æ?
      const xAxisData = dates.map((date) => {
        const parts = date.split("-");
        return `${parseInt(parts[1])}/${parseInt(parts[2])}`;
      });

      const seriesData = dates.map((date) => dailySum[date]);

      console.log("æ¯æ—¥è¶¨å‹¢?–æ•¸??", { ?¥æ?: xAxisData, ?‘é?: seriesData });

      // è¨­ç½®?–è¡¨?¸é?
      const isMobile = window.innerWidth < 768; // æª¢æ¸¬?¯å¦?ºç§»?•è¨­??
      chart.setOption({
        // ?ªé™¤æ¨™é??ç½®
        tooltip: {
          trigger: "axis",
          formatter: function (params: any) {
            const value = params[0].value;
            return `${params[0].axisValue}<br/>?¯å‡º?‘é?: NT$${value}`;
          },
          confine: true,
        },
        grid: {
          left: isMobile ? "10%" : "3%",
          right: isMobile ? "5%" : "4%",
          bottom: "15%",
          containLabel: true,
        },
        xAxis: {
          type: "category",
          data: xAxisData,
          axisLine: { lineStyle: { color: "#999" } }, // é¡è‰²èª¿æ·¡ï¼Œå? #666 ??#999
          axisLabel: {
            color: "#666", // é¡è‰²èª¿æ·¡ï¼Œå? #2E2E2E ??#666
          },
        },
        yAxis: {
          type: "value",
          axisLine: { lineStyle: { color: "#999" } }, // é¡è‰²èª¿æ·¡ï¼Œå? #666 ??#999
          axisLabel: {
            formatter: "{value} ??,
            color: "#666", // é¡è‰²èª¿æ·¡ï¼Œå? #2E2E2E ??#666
          },
        },
        series: [
          {
            name: "æ¯æ—¥?¯å‡º",
            type: "bar",
            data: seriesData,
            itemStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: "#B8E3C9" },
                { offset: 1, color: "#D4F0DF" },
              ]),
            },
          },
        ],
      });

      // è¨­ç½®å¯¦ä?å¾Œå?ä¿å?
      setDailyChartInstance(chart);
      console.log("æ¯æ—¥è¶¨å‹¢?–å?å§‹å?å®Œæ?");
    } catch (e) {
      console.error("?µå»ºæ¯æ—¥è¶¨å‹¢?–å‡º??", e);
      // ?ºéŒ¯?‚é¡¯ç¤ºç©º?–è¡¨
      createEmptyDailyChart();
    }
  };

  // å®Œå…¨?å¯«?„æ•¸?šå?å§‹å??è¼¯
  useEffect(() => {
    const initializeAppData = async () => {
      console.log("===========?‰ç”¨?¸æ??å??–é?å§?==========");
      console.log("Firebase??¥?€?‹æª¢??..");

      // ?ªæ??»å…¥?¨æˆ¶?å?è¼‰æ•¸??      if (!currentUser || !currentUser.uid) {
        console.log("?¨æˆ¶?ªç™»?¥ï?ä¸å?è¼‰æ•¸??);
        setExpenses([]);
        return;
      }
      
      // ?²å??¨æˆ¶ID?¨æ–¼?¸æ??æ¿¾
      const userId = currentUser.uid;
      console.log("?¶å??¨æˆ¶ID:", userId);
      console.log("?¨æˆ¶?µç®±:", currentUser.email);

      // é¡¯ç¤º? è?ä¸­æ?ç¤?      setSuccessMessage("æ­?œ¨???ä¸?..");
      setShowSuccessMessage(true);

      try {
        console.log("?—è©¦å¾Firebase?²å??€?°æ•¸??..");

        // 1. æª¢æŸ¥?¸æ?åº«é€?¥
        console.log("Firestoreå¯¦ä?:", db ? "å·²å?å§‹å?" : "?ªå?å§‹å?");

        // 2. æ§‹å»º?¥è©¢
        const expensesRef = collection(db, "expenses");
        console.log("?†å?è·¯å?: expenses");

        // ?¥è©¢?¶å??¨æˆ¶?„è???      const q = query(
          expensesRef,
          where("userId", "==", userId),
          orderBy("createdAt", "desc"),
        );
        console.log("?¥è©¢æ¢ä»¶: userId =", userId);

        // 3. ?·è??¥è©¢
        console.log("?‹å??·è??¥è©¢...");
        const querySnapshot = await getDocs(q);
        console.log("?¥è©¢å®Œæ?, çµæ??¸é?:", querySnapshot.size);
        
        // ?•ç??¥è©¢çµæ?
        const fetchedExpenses: Expense[] = [];

        // 4. ?•ç?çµæ?
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          console.log("è®€?–æ?æª”ID:", doc.id, "?¨æˆ¶ID:", data.userId);

          // ç¢ºè??¨æˆ¶ID?¹é?
          if (data.userId === userId) {
            try {
              // å®‰å…¨?°è??†æ—¥?Ÿè???              let expenseDate;
              if (data.date && typeof data.date.toDate === "function") {
                // Firestore Timestamp å°è±¡
                expenseDate = data.date.toDate();
              } else if (data.date && data.date._seconds) {
                // Firestore Timestamp å¾JSON
                expenseDate = new Date(data.date._seconds * 1000);
              } else if (data.date instanceof Date) {
                // å·²ç??¯æ—¥?Ÿå?è±?                expenseDate = data.date;
              } else if (typeof data.date === "string") {
                // å­—ç¬¦ä¸²æ—¥??                expenseDate = new Date(data.date);
              } else {
                // é»˜è??ºç•¶?æ—¥??                console.warn(`?¡æ??„æ—¥?Ÿæ ¼å¼? ${JSON.stringify(data.date)}`);
                expenseDate = new Date();
              }

              fetchedExpenses.push({
            id: doc.id,
            amount: data.amount,
            category: data.category,
                date: expenseDate,
                notes: data.notes || "",
            userId: data.userId,
              });
            } catch (e) {
              console.error(`?•ç?æ¶ˆè²»?ç´° ${doc.id} ?‚å‡º??`, e);
            }
          }
        });

        console.log(
          `?å?å¾Firebase?²å?äº?${fetchedExpenses.length} ç­†æ?è²»æ?ç´°`,
        );
        if (fetchedExpenses.length === 0) {
          console.log(
            "?ç¤º: æ²’æ??¾åˆ°æ¶ˆè²»?ç´°ï¼Œè?ç¢ºè??¯å¦å·²æ·»? æ?è²»æ?ç´°æ?ç´¢å??¯å¦å·²å‰µå»?,
          );
        }

        // ?´æ–°UI?€??        setExpenses(fetchedExpenses);

        // ç¢ºä??¨è¨­ç½®expenseså¾Œå¼·?¶é??°æ¸²?“å?è¡?        // å¢å??™é?å»¶é²?‚é?ï¼Œç¢ºä¿æ•¸?šå?DOMå®Œå…¨?´æ–°å¾Œå?æ¸²æ??–è¡¨
        console.log("æº–å??æ–°æ¸²æ??–è¡¨...");
        setTimeout(() => {
          try {
            // ?ˆå¼·?¶é??°æ¸²?“ä?æ¬?            forceRerender();

            // ?å?ä¸€?‹å»¶?²ç¢ºä¿DOMå®Œå…¨æ¸²æ?
            setTimeout(() => {
              try {
                console.log("?—è©¦æ¸²æ??“é???..");
                if (chartRef.current) {
                  initPieChart();
                }

                console.log("?—è©¦æ¸²æ?æ¯æ—¥è¶¨å‹¢??..");
                if (dailyChartRef.current) {
                  initDailyChart();
                }

                // è§¸ç™¼?–è¡¨?æ–°æ¸²æ?äº‹ä»¶
                window.dispatchEvent(new Event("expenses-changed"));
                console.log("?–è¡¨æ¸²æ?å®Œæ?");
              } catch (error) {
                console.error("?–è¡¨æ¸²æ?å¤±æ?:", error);
              }
            }, 300);
          } catch (error) {
            console.error("?–è¡¨æ¸²æ??æ??™å¤±??", error);
          }
        }, 800); // å¢å?ä¸»å»¶?²æ???
        // ?œé?? è??ç¤º
        if (successMessageTimer.current) {
          window.clearTimeout(successMessageTimer.current);
        }
        setShowSuccessMessage(false);

        console.log("===========?‰ç”¨?¸æ??å??–å???==========");
      } catch (error) {
        console.error("å¾Firebase?²å??¸æ?å¤±æ?:", error);
        // é¡¯ç¤º?´è©³ç´°ç??¯èª¤ä¿¡æ¯
        if (error instanceof Error) {
          console.error("?¯èª¤é¡å?:", error.name);
          console.error("?¯èª¤æ¶ˆæ¯:", error.message);
          console.error("?¯èª¤?†æ£§:", error.stack);
          setError(`è®€?–æ?è²»æ?ç´°å¤±?? ${error.message}`);
        } else {
          setError("è®€?–æ?è²»æ?ç´°å¤±?—ï?è«‹æª¢?¥æ§?¶æª¯?¥è?");
        }
        setTimeout(() => setError(null), 5000);
        setExpenses([]);
        setShowSuccessMessage(false);
        console.log("===========?‰ç”¨?¸æ??å??–å¤±??==========");
      }
    };

    // ä½¿initializeAppData?¯ä»¥?¨ç?ä»¶å…§?¨èª¿??    (window as any).initializeAppData = initializeAppData;

    // ?·è??å???        if (currentUser) {
      initializeAppData();
    } else {
      // ?¨æˆ¶?ªç™»?¥ï?æ¸…ç©º?¸æ?
      setExpenses([]);
      setShowLoginForm(true);
    }

    // ?¶é??¢è??ºå¯è¦‹æ??æ–°? è??¸æ?
    const handleVisibilityChange = () => {
      if (document.visibilityState === "visible" && currentUser) {
        console.log("?é¢è®Šç‚º?¯è?ï¼Œé??°å?è¼‰æ•¸??);
        initializeAppData();
      }
    };

    document.addEventListener("visibilitychange", handleVisibilityChange);

    return () => {
      document.removeEventListener("visibilitychange", handleVisibilityChange);
    };
  }, [currentUser]);

  // ?¶ç”¨?¶æœª?»å…¥?‚ï??ªå?é¡¯ç¤º?»å…¥?Œé¢
  useEffect(() => {
    if (!currentUser) {
      setShowLoginForm(true);
    } else {
      // ?¶ç”¨?¶ç™»?¥æ??Ÿå?ï¼Œé??‰ç™»?¥è¡¨??      setShowLoginForm(false);
    }
  }, [currentUser]);

  // ?¹æ?é¡åˆ¥?²å?å°æ??„å?æ¨?  const getCategoryIcon = (category: string): string => {
    const categoryIcons: Record<string, string> = {
      é¤é£²: "fa-utensils",
      äº¤é€? "fa-car",
      å¨›æ?: "fa-film",
      è³¼ç‰©: "fa-shopping-bag",
      ?™è‚²: "fa-book",
      ?«ç?: "fa-heartbeat",
      ?•è?: "fa-chart-line",
      æ°´é›»: "fa-bolt",
      ?¶ä?: "fa-ellipsis-h",
    };

    return categoryIcons[category] || "fa-ellipsis-h";
  };

  // ??½?’è?æ¦œé?è«‹æŸ¥?‹ä?ä»?  useEffect(() => {
    const handleShowLeaderboardInvites = () => {
      setShowLeaderboardInvites(true);
    };

    window.addEventListener(
      "showLeaderboardInvites",
      handleShowLeaderboardInvites,
    );

    return () => {
      window.removeEventListener(
        "showLeaderboardInvites",
        handleShowLeaderboardInvites,
      );
    };
  }, []);

  // ?·æ–°å¾Œç??¸æ??¢å¾©æ©Ÿåˆ¶ - å®Œå…¨?å¯«
  useEffect(() => {
    const recoverDataAfterRefresh = async () => {
      // å¦‚æ??¨æˆ¶?ªç™»?¥ï?ä¸åŸ·è¡Œæ¢å¾?      if (!currentUser || !currentUser.uid) {
        return;
      }

      console.log("===?‹å??·æ–°å¾Œæ•¸?šæ¢å¾©é?ç¨?==");

      try {
        // ?ˆæ?ç©ºç•¶?ç??‹ï??¿å?é¡¯ç¤º?Šæ•¸??        setExpenses([]);

        // ?´æ¥å¾Firebase?²å??€?°æ•¸??        const userId = currentUser.uid;
        console.log(`?—è©¦?ºç”¨??${userId} å¾Firebase?²å??€?°æ•¸?š`);

        const expensesRef = collection(db, "expenses");
        const q = query(
          expensesRef,
          where("userId", "==", userId),
          orderBy("createdAt", "desc"),
        );

        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
          const fetchedExpenses: Expense[] = [];

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            // ?´æ ¼é©—è??¯ç•¶?ç”¨?¶ç?è¨˜é?
            if (data.userId === userId) {
              try {
                // å®‰å…¨?°è??†æ—¥?Ÿè???                let expenseDate;
                if (data.date && typeof data.date.toDate === "function") {
                  // Firestore Timestamp å°è±¡
                  expenseDate = data.date.toDate();
                } else if (data.date && data.date._seconds) {
                  // Firestore Timestamp å¾JSON
                  expenseDate = new Date(data.date._seconds * 1000);
                } else if (data.date instanceof Date) {
                  // å·²ç??¯æ—¥?Ÿå?è±?                  expenseDate = data.date;
                } else if (typeof data.date === "string") {
                  // å­—ç¬¦ä¸²æ—¥??                  expenseDate = new Date(data.date);
                } else {
                  // é»˜è??ºç•¶?æ—¥??                  console.warn(`?¡æ??„æ—¥?Ÿæ ¼å¼? ${JSON.stringify(data.date)}`);
                  expenseDate = new Date();
                }

                fetchedExpenses.push({
                  id: doc.id,
                  amount: data.amount,
                  category: data.category,
                  date: expenseDate,
                  notes: data.notes || "",
                  userId: data.userId,
                });
              } catch (e) {
                console.error(`?•ç?æ¶ˆè²»?ç´° ${doc.id} ?‚å‡º??`, e);
              }
            }
          });

          if (fetchedExpenses.length > 0) {
            console.log(
              `?å?å¾Firebase?²å? ${fetchedExpenses.length} ç­†æ?è²»æ?ç´°`,
            );

            // ?´æ–°React?€??            setExpenses(fetchedExpenses);

            // å¼·åˆ¶?´æ–°UI?Œå?è¡?            forceRerender();

            // å¢å?å»¶é²?‚é?ï¼Œç¢ºä¿æ•¸?šå·²å®Œå…¨?´æ–°ä¸”DOMå·²æ¸²?“å???            setTimeout(() => {
              try {
                console.log("?¸æ??¢å¾©å¾Œé??°æ¸²?“å?è¡?..");
                // è§¸ç™¼?–è¡¨?æ–°æ¸²æ?äº‹ä»¶
                window.dispatchEvent(new Event("expenses-changed"));

                // ?´æ¥èª¿ç”¨?å??–å‡½??                if (chartRef.current) {
                  initPieChart();
                }

                if (dailyChartRef.current) {
                  initDailyChart();
                }

                console.log("?¸æ??¢å¾©å¾Œå?è¡¨æ¸²?“å???);
              } catch (error) {
                console.error("?¸æ??¢å¾©å¾Œå?è¡¨æ¸²?“å¤±??", error);
              }
            }, 800);

            // é¡¯ç¤º?å?ä¿¡æ¯
            setSuccessMessage("?¸æ?å·²å?æ­?);
            setShowSuccessMessage(true);
            if (successMessageTimer.current) {
              window.clearTimeout(successMessageTimer.current);
            }
            successMessageTimer.current = window.setTimeout(
              () => setShowSuccessMessage(false),
              1500,
            );
          } else {
            console.log("Firebaseä¸­æ??‰æ‰¾?°ç•¶?ç”¨?¶ç?è¨˜é?");
            setExpenses([]);
          }
        } else {
          console.log("Firebase?¥è©¢çµæ??ºç©º");
          setExpenses([]);
      }
    } catch (error) {
        console.error("?·æ–°å¾Œæ•¸?šæ¢å¾©å¤±??", error);
        setError("?¡æ??¢å¾©?¸æ?ï¼Œè??—è©¦?‹å??·æ–°?é¢");
        setTimeout(() => setError(null), 3000);
      } finally {
        console.log("===?¸æ??¢å¾©?ç?çµæ?===");
      }
    };

    // å¦‚æ??¨æˆ¶å·²ç™»?¥ï??·è??¸æ??¢å¾©
    if (currentUser) {
      recoverDataAfterRefresh();
    }

    // ??½å¼·åˆ¶?¸æ??¢å¾©äº‹ä»¶
    const handleForceDataRecovery = () => {
      console.log("?¶åˆ°å¼·åˆ¶?¸æ??¢å¾©äº‹ä»¶");
      recoverDataAfterRefresh();
    };

    window.addEventListener("force_data_recovery", handleForceDataRecovery);

    return () => {
      window.removeEventListener(
        "force_data_recovery",
        handleForceDataRecovery,
      );
    };
  }, [currentUser]);

  // å¼·å?æ·»å?è¨˜é??Ÿèƒ½ - ?²ä?æ­¥ç°¡?–æ?ç¨‹ä¸¦?é??Ÿåº¦
  const addExpense = async (expense: {
    amount: number;
    category: string;
    date: string;
    notes: string;
    attachments?: File[];
    isShared?: boolean;
    sharedWith?: Array<{
      userId: string;
      nickname: string;
      email?: string;
      photoURL?: string;
      amount: number;
    }>;
  }): Promise<boolean> => {
    try {
      if (!currentUser) {
        throw new Error("?¨æˆ¶?ªç™»??);
      }

      // æº–å?è¦ä?å­˜ç??¸æ?
      const expenseData: any = {
        amount: expense.amount,
        category: expense.category,
        date: new Date(expense.date),
        notes: expense.notes,
        userId: currentUser.uid,
        createdAt: new Date(),
        isShared: expense.isShared || false
      };

      // ä¿å???Firestore
      const expenseRef = collection(db, "expenses");
      const docRef = await addDoc(expenseRef, expenseData);
      
      // å¦‚æ??¯å?å¸³æ”¯?ºï?ä¿å??†å¸³ä¿¡æ¯
      if (expense.isShared && expense.sharedWith && expense.sharedWith.length > 0) {
        // æº–å??ƒè??…æ•¸??        const participants = expense.sharedWith.map(friend => ({
          userId: friend.userId,
          nickname: friend.nickname,
          email: friend.email,
          photoURL: friend.photoURL,
          amount: friend.amount,
          paid: false
        }));
        
        // ?å??ƒè???ID ?—è¡¨ï¼Œæ–¹ä¾¿æŸ¥è©?        const participantIds = participants.map(p => p.userId);
        
        // ?µå»º?†å¸³è¨˜é?
        const splitData = {
          title: `?†å¸³: ${expense.category} ${expense.amount}?ƒ`,
          description: expense.notes || '',
          totalAmount: expense.amount,
          date: new Date(expense.date),
          originalExpenseId: docRef.id,
          status: 'pending',
          participants,
          participantIds, // æ·»å??ƒè???ID ?—è¡¨
          creatorId: currentUser.uid,
          created: new Date()
        };
        
        // ä¿å??°å?å¸³é???        const splitRef = collection(db, "splitExpenses");
        await addDoc(splitRef, splitData);
        
        // ?´æ–°?Ÿæ”¯?ºè??„ï?æ¨™è??ºå·²?†å¸³
        await updateDoc(doc(db, "expenses", docRef.id), {
          isSplit: true
        });
      }

      setSuccessMessage("?¯å‡ºå·²æ??Ÿæ·»? ï?");
      setShowSuccessMessage(true);
      if (successMessageTimer.current) {
        window.clearTimeout(successMessageTimer.current);
      }
      successMessageTimer.current = window.setTimeout(
        () => setShowSuccessMessage(false),
        3000
      );

      // ?·æ–°?¯å‡º?¸æ?
      if (typeof (window as any).initializeAppData === 'function') {
        await (window as any).initializeAppData();
      }
      return true;
    } catch (error) {
      console.error("æ·»å??¯å‡º?‚ç™¼?ŸéŒ¯èª?", error);
      setError("æ·»å??¯å‡ºå¤±æ?ï¼Œè?ç¨å??è©¦");
      return false;
    }
  };

  // ?²å?é¡åˆ¥å°æ??„é???  const getCategoryColor = (category: string): string => {
    const categoryColors: Record<string, string> = {
      é¤é£²: "#F4606C", // ä¿®æ”¹?ºç??²ç³»
      äº¤é€? "#B8E3C9", // ?„è·ç¶?(elora-mint)
      å¨›æ?: "#FAC6CD", // ç²‰ç???(elora-pink)
      è³¼ç‰©: "#C6B2DD", // æ·ºç´«??(elora-purple-light)
      ?™è‚²: "#E6CEAC", // ä¿®æ”¹?ºæ·ºæ£•è‰²
      ?«ç?: "#FFE2E5", // æ·ºç?ç´…è‰² (elora-pink-light)
      ?•è?: "#90F1EF", // ä¿®æ”¹?ºé??è‰²
      æ°´é›»: "#FAE278", // æ·ºé???      ?¶ä?: "#A487C3", // ç´«è‰² (elora-purple)
    };

    return categoryColors[category] || "#A487C3";
  };

  // å°?Expense é¡å?è½‰æ??ºè¡¨?®é?è¦ç??¼å?
  const convertExpenseForForm = (expense: Expense | null) => {
    if (!expense) return null;

    return {
      id: expense.id,
      amount: expense.amount,
      category: expense.category.name,
      date:
        expense.date instanceof Date
          ? expense.date.toISOString().slice(0, 10)
          : new Date().toISOString().slice(0, 10),
      notes: expense.notes,
      attachments: [],
    };
  };

  // ç·¨è¼¯?¯å‡ºè¨˜é?
  const editExpense = (expense: Expense) => {
    setEditingExpense(expense);
    setShowExpenseForm(true);
  };

  // ?´æ–°?¯å‡ºè¨˜é?
  const updateExpense = async (updatedData: {
    amount: number;
    category: string;
    date: string;
    notes: string;
    attachments?: File[];
  }): Promise<boolean> => {
    try {
      if (!currentUser || !editingExpense) return false;
      
      console.log("?‹å??´æ–°?¯å‡ºè¨˜é?:", updatedData);
      
      // ?•ç??„ä»¶
      let attachmentUrls: string[] = [];
      if (updatedData.attachments && updatedData.attachments.length > 0) {
        // ?™è£¡?¯ä»¥æ·»å??°ç??„ä»¶ä¸Šå‚³?è¼¯
        attachmentUrls = updatedData.attachments.map((file) =>
          URL.createObjectURL(file),
        );
      }

      // å®‰å…¨?°è??†æ—¥?Ÿè???      let expenseDate;
      try {
        // ?—è©¦?µå»º?¥æ?å°è±¡
        expenseDate = new Date(updatedData.date);
        // æª¢æŸ¥?¯å¦?¯æ??ˆæ—¥??        if (isNaN(expenseDate.getTime())) {
          throw new Error("Invalid date");
        }
      } catch (e) {
        // é»˜è??ºç•¶?æ—¥??        console.warn(`?¡æ??„æ—¥?Ÿæ ¼å¼? ${JSON.stringify(updatedData.date)}`);
        expenseDate = new Date();
      }
      
      // ç«‹å³?´æ–°UI
      const updatedExpense: Expense = {
        ...editingExpense,
        amount: updatedData.amount,
        category: {
          id: updatedData.category,
          name: updatedData.category,
        icon: getCategoryIcon(updatedData.category),
        },
        date: expenseDate,
        notes: updatedData.notes || "",
        userId: currentUser.uid,
      };

      setExpenses((prev) => {
        const updated = prev.map((item) =>
          item.id === editingExpense.id ? updatedExpense : item,
        );
        // ?Œæ??´æ–°ç·©å?
        if (currentUser) {
          setUserDataCache((cache) => ({
            ...cache,
            [currentUser.uid]: updated,
          }));
        }
        return updated;
      });
      
      // ?´æ–°Firebase?¸æ?
      const expenseDocRef = doc(db, "expenses", editingExpense.id);
      await updateDoc(expenseDocRef, {
        amount: updatedData.amount,
        category: updatedData.category,
        // å°‡æ—¥?Ÿè??›ç‚º Timestamp å°è±¡å­˜å„²
        date: Timestamp.fromDate(new Date(updatedData.date)),
        notes: updatedData.notes,
        attachmentUrls,
        updatedAt: new Date(),
      });
      
      console.log("?¯å‡ºè¨˜é?å·²æ›´?°ï?ID:", editingExpense.id);
      
      // ?ç½®ç·¨è¼¯?€??      setEditingExpense(null);
      
      return true;
    } catch (error) {
      console.error("?´æ–°?¯å‡ºå¤±æ?:", error);
      alert("?´æ–°?¯å‡ºè¨˜é??‚å‡º?¾éŒ¯èª¤ï?è«‹ç?å¾Œå?è©?);
      return false;
    }
  };

  // ?ªé™¤?¯å‡ºè¨˜é? - ?²ä?æ­¥å„ª?–ç???  const deleteExpense = async (id: string) => {
    try {
      if (!currentUser) {
        setError("è«‹å??»å…¥?åˆª?¤è???);
        setTimeout(() => setError(null), 3000);
        return;
      }

      console.log(`?‹å??ªé™¤?¯å‡ºè¨˜é?: ${id}`);

      // ç«‹å³?´æ–°UIï¼Œæ?é«˜éŸ¿?‰é€Ÿåº¦
      setExpenses((prev) => prev.filter((expense) => expense.id !== id));

      // ç«‹å³é¡¯ç¤º?å?è¨Šæ¯
      setSuccessMessage("è¨˜é?å·²åˆª??);
      setShowSuccessMessage(true);
      if (successMessageTimer.current) {
        window.clearTimeout(successMessageTimer.current);
      }
      successMessageTimer.current = window.setTimeout(
        () => setShowSuccessMessage(false),
        1500,
      );

      // å¾Œè‡º?·è?Firebaseè¨˜é??ªé™¤
      try {
        await deleteDoc(doc(db, "expenses", id));
        console.log(`Firebaseè¨˜é??ªé™¤?å?: ${id}`);
      } catch (error) {
        console.error(`Firebase?ªé™¤å¤±æ?:`, error);
        // ?³ä¾¿Firebase?ªé™¤å¤±æ?ï¼ŒUIå·²ç??´æ–°ï¼Œç”¨?¶é?é©—ä??—å½±??        // ä¸‹æ¬¡?·æ–°?‚æ?å¾Firebase?²å?æ­?¢º?¸æ?
      }

      // ?å?æ­¥æ›´?°å?è¡?      setTimeout(
        () => window.dispatchEvent(new Event("expenses-changed")),
        100,
      );
    } catch (error) {
      console.error("?ªé™¤è¨˜é??‚ç™¼?Ÿæœª?¥éŒ¯èª?", error);
      setError("?ªé™¤å¤±æ?ï¼Œè?ç¨å??è©¦");
      setTimeout(() => setError(null), 3000);
    }
  };

  // ?æ??“é??–å?å§‹å?
useEffect(() => {
    // ?å??–å?è¡?    initPieChart();

    // ?•ç?çª—å£å¤§å?è®Šå?
    const handleResize = () => {
      if (chartInstance) {
        // é¦–å?èª¿æ•´å¤§å?
        chartInstance.resize();

        // ?æ–°?‰ç”¨ä½ˆå?èª¿æ•´ä»¥é©?‰æ–°çª—å£å¤§å?
        const isMobile = window.innerWidth < 768;
        const isSelectedMode = selectedCategory !== null;

        // ?æ–°è¨­ç½®ä½ˆå??ƒæ•¸ï¼Œä?ä¿æ??¶ä??¸é?ä¸è?
        chartInstance.setOption({
          title: null, // ç¢ºä?ä¸é¡¯ç¤ºæ?é¡?          legend: {
            show: !isSelectedMode,
            left: "center",
          },
          series: [
            {
              center: [
                isSelectedMode ? (isMobile ? "48%" : "45%") : "50%",
                "45%", // å¾?40%"?¹ç‚º"45%"ï¼Œå?ä¸‹ç§»??              ],
            },
          ],
        });
      }
    };
    window.addEventListener("resize", handleResize);

    // ?•ç??¸æ?è®Šå?
    const handleExpensesChanged = () => {
      console.log("?¯å‡º?¸æ?è®Šæ›´, ?æ–°æ¸²æ??“é???);
      initPieChart();
    };
    window.addEventListener("expenses-changed", handleExpensesChanged);

    return () => {
      // æ¸…ç?
      if (chartInstance) {
        chartInstance.dispose();
      }
      window.removeEventListener("resize", handleResize);
      window.removeEventListener("expenses-changed", handleExpensesChanged);
    };
  }, [expenses, chartRef.current]);

  // ??½selectedCategory?€?‹è??–ï??´æ–°é¤…å?ä½ç½®
  useEffect(() => {
    if (chartInstance) {
      const isMobile = window.innerWidth < 768; // æª¢æ¸¬?¯å¦?ºç§»?•è¨­??
      // ç§»é™¤æ¨™é?è¨­å?ï¼Œèª¿?´å?ä¾‹å?ä½ç½®
      chartInstance.setOption({
        title: null, // ç¢ºä?ä¸é¡¯ç¤ºæ?é¡?      legend: {
          show: !selectedCategory, // ?¸ä¸­é¡åˆ¥?‚éš±?å?ä¾?          orient: "horizontal",
          left: "center",
        bottom: 10,
        },
        series: [
          {
            center: [
              selectedCategory ? (isMobile ? "48%" : "45%") : "50%",
              "45%", // å¾?40%"?¹ç‚º"45%"ï¼Œå?ä¸‹ç§»??            ],
          },
        ],
      });
    }
  }, [selectedCategory]);

  // ?æ?æ¯æ—¥è¶¨å‹¢?–å?å§‹å?
  useEffect(() => {
    // ?å??–å?è¡?    initDailyChart();

    // ?•ç?çª—å£å¤§å?è®Šå?
    const handleResize = () => {
      if (dailyChartInstance) {
        dailyChartInstance.resize();

        // ç¢ºä?è¶¨å‹¢?–åœ¨ç§»å?ç«¯ä??½æ­£ç¢ºé¡¯ç¤?        const isMobile = window.innerWidth < 768;
        dailyChartInstance.setOption({
          grid: {
            left: isMobile ? "10%" : "3%",
            right: isMobile ? "5%" : "4%",
            containLabel: true,
          },
        });
      }
    };
    window.addEventListener("resize", handleResize);

    // ?•ç??¸æ?è®Šå?
    const handleExpensesChanged = () => {
      console.log("?¯å‡º?¸æ?è®Šæ›´, ?æ–°æ¸²æ?æ¯æ—¥è¶¨å‹¢??);
      initDailyChart();
    };
    window.addEventListener("expenses-changed", handleExpensesChanged);
  
  return () => {
      // æ¸…ç?
      if (dailyChartInstance) {
        dailyChartInstance.dispose();
      }
      window.removeEventListener("resize", handleResize);
      window.removeEventListener("expenses-changed", handleExpensesChanged);
    };
  }, [expenses, dailyChartRef.current]);

  // ç¯©é¸?¶å??¸ä¸­?¥æ??„æ?è²?- å®Œå…¨?å¯«ç¢ºä??¥æ?æ¯”è?æ­?¢º
  const getFilteredExpenses = () => {
    console.log("===?‹å?ç¯©é¸?¯å‡ºè¨˜é?===");
    console.log("?¶å??¸æ??„æ—¥?Ÿé¸??", selectedDateOption);

    // ?¨éƒ¨è¨˜é??´æ¥è¿”å?
    if (selectedDateOption === "all") {
      console.log("é¡¯ç¤º?¨éƒ¨æ¶ˆè²»è¨˜é?");
      return expenses;
    }

    // ?•ç??‰æ??æ¿¾
    if (selectedDateOption === "month") {
      console.log("?‰æœ¬?ˆé?æ¿¾æ?è²»è???);
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      return expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate.getMonth() === currentMonth && 
               expenseDate.getFullYear() === currentYear;
      });
    }
    
    // ?•ç??¸æ??ˆä»½?æ¿¾
    if (selectedDateOption === "month_select") {
      console.log("?‰é¸?‡ç??ˆä»½?æ¿¾æ¶ˆè²»è¨˜é?:", selectedMonth);
      const [year, month] = selectedMonth.split('-').map(Number);
      
      return expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate.getMonth() === month - 1 && 
               expenseDate.getFullYear() === year;
      });
    }
    
    // ?•ç??¬é€±é?æ¿?    if (selectedDateOption === "this_week") {
      console.log("?‰æœ¬?±é?æ¿¾æ?è²»è???);
      const today = new Date();
      const currentDay = today.getDay() || 7; // ?•ç??±æ—¥???„æ?æ³?      const firstDayOfWeek = new Date(today);
      firstDayOfWeek.setDate(today.getDate() - (currentDay - 1));
      firstDayOfWeek.setHours(0, 0, 0, 0);
      
      const lastDayOfWeek = new Date(firstDayOfWeek);
      lastDayOfWeek.setDate(firstDayOfWeek.getDate() + 6);
      lastDayOfWeek.setHours(23, 59, 59, 999);
      
      console.log("?¬é€±ç???", {
        ?‹å?: firstDayOfWeek.toISOString(),
        çµæ?: lastDayOfWeek.toISOString()
      });
      
      return expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate >= firstDayOfWeek && expenseDate <= lastDayOfWeek;
      });
    }
    
    // ?•ç?ä¸Šé€±é?æ¿?    if (selectedDateOption === "last_week") {
      console.log("?‰ä??±é?æ¿¾æ?è²»è???);
      const today = new Date();
      const currentDay = today.getDay() || 7; // ?•ç??±æ—¥???„æ?æ³?      const firstDayOfLastWeek = new Date(today);
      firstDayOfLastWeek.setDate(today.getDate() - (currentDay - 1) - 7);
      firstDayOfLastWeek.setHours(0, 0, 0, 0);
      
      const lastDayOfLastWeek = new Date(firstDayOfLastWeek);
      lastDayOfLastWeek.setDate(firstDayOfLastWeek.getDate() + 6);
      lastDayOfLastWeek.setHours(23, 59, 59, 999);
      
      console.log("ä¸Šé€±ç???", {
        ?‹å?: firstDayOfLastWeek.toISOString(),
        çµæ?: lastDayOfLastWeek.toISOString()
      });
      
      return expenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate >= firstDayOfLastWeek && expenseDate <= lastDayOfLastWeek;
      });
    }

    // ?²å?ç¯©é¸?¥æ?
    let filterDate: Date;

    if (selectedDateOption === "today") {
      // æ¯æ¬¡?½é??°ç²?–ä?å¤©ç??¥æ?ï¼Œä?ä½¿ç”¨ç·©å?
      filterDate = new Date();
      filterDate.setHours(0, 0, 0, 0);
      console.log("ä½¿ç”¨ä»Šå¤©ä½œç‚ºç¯©é¸?¥æ?:", filterDate.toISOString());
    } else if (selectedDateOption === "yesterday") {
      // ?¨å¤© = ?¶å??¥æ?æ¸›å»1å¤?      filterDate = new Date();
      filterDate.setHours(0, 0, 0, 0);
      filterDate.setDate(filterDate.getDate() - 1);
      console.log("ä½¿ç”¨?¨å¤©ä½œç‚ºç¯©é¸?¥æ?:", filterDate.toISOString());
    } else {
      // ä½¿ç”¨?¨æˆ¶?¸æ??„æ—¥??      filterDate = selectedDate;
      console.log("ä½¿ç”¨?¸å??¥æ?ä½œç‚ºç¯©é¸?¥æ?:", filterDate.toISOString());
    }

    // ?å?å¹´æ??¥ç”¨?¼ç²¾ç¢ºæ?è¼?    const filterYear = filterDate.getFullYear();
    const filterMonth = filterDate.getMonth();
    const filterDay = filterDate.getDate();

    console.log("ç¯©é¸?¥æ?çµ„æ??¨å?:", {
      å¹? filterYear,
      ?? filterMonth + 1,
      ?? filterDay,
    });

    // ä½¿ç”¨å¹´æ??¥ç²¾ç¢ºæ?è¼ƒç¯©??    const filtered = expenses.filter((expense) => {
      try {
        // ?å??¯å‡ºè¨˜é??„å¹´?ˆæ—¥
        const expenseYear = expense.date.getFullYear();
        const expenseMonth = expense.date.getMonth();
        const expenseDay = expense.date.getDate();

        // ?¥æ?å¿…é?ç²¾ç¢º?¹é?å¹´æ???        const matches =
          expenseYear === filterYear &&
          expenseMonth === filterMonth &&
          expenseDay === filterDay;

        if (matches) {
          console.log("?¹é??„æ”¯??", {
            id: expense.id,
            ?¥æ?: expense.date.toISOString(),
            å¹? expenseYear,
            ?? expenseMonth + 1,
            ?? expenseDay,
            ?‘é?: expense.amount,
          });
        }

        return matches;
      } catch (err) {
        console.error("ç¯©é¸?‚å‡º??", err, expense);
        return false;
      }
    });

    console.log(`ç¯©é¸çµæ?: ?¾åˆ° ${filtered.length} æ¢è??„`);
    return filtered;
  };

  const filteredTransactions = getFilteredExpenses();

  // ?¢ç?ä¸€?‹æ¸²??keyï¼Œç”¨?¼å¼·?¶ç?ä»¶é??°æ¸²??  const [renderKey, setRenderKey] = useState<number>(Date.now());

  // å¼·åˆ¶?æ–°æ¸²æ?çµ„ä»¶?„å‡½??  const forceRerender = () => {
    setRenderKey(Date.now());
  };

  // ?¨æ”¯?ºæ•¸?šè??´æ?ï¼Œå¼·?¶ç?ä»¶é??°æ¸²??  useEffect(() => {
    forceRerender();
  }, [expenses.length]);

  // Firebase??¥æ¸¬è©¦?½æ•¸
  const testFirebaseConnection = async () => {
    try {
      if (!currentUser) {
        setError("è«‹å??»å…¥?æ¸¬è©?);
        setTimeout(() => setError(null), 3000);
        return;
      }

      setSuccessMessage("æ­?œ¨æ¸¬è©¦???...");
      setShowSuccessMessage(true);

      console.log("===========?‹å????æ¸¬è©¦===========");
      console.log("?¶å??¨æˆ¶:", currentUser.uid, currentUser.email);
      console.log("æª¢æŸ¥Firestoreå¯¦ä?:", db ? "å·²å?å§‹å?" : "?ªå?å§‹å?");

      // ?—è©¦æ·»å?ä¸€æ¢æ¸¬è©¦è???      const testRecord = {
        amount: 1,
        category: "æ¸¬è©¦",
        date: new Date().toISOString().slice(0, 10),
        notes: "Firebase??¥æ¸¬è©¦ - " + new Date().toISOString(),
        userId: currentUser.uid,
        createdAt: new Date(),
      };

      console.log("æº–å?æ·»å?æ¸¬è©¦æ¶ˆè²»?ç´°:", testRecord);

      // æ·»å??°Firebase
      const docRef = await addDoc(collection(db, "expenses"), testRecord);

      console.log("æ¸¬è©¦æ¶ˆè²»?ç´°å·²æ·»? ï?ID:", docRef.id);
      console.log("===========???æ¸¬è©¦?å?===========");

      // é¡¯ç¤º?å?æ¶ˆæ¯
      setSuccessMessage("???æ­?¸¸ï¼å·²æ·»å?æ¸¬è©¦æ¶ˆè²»?ç´°");
      setShowSuccessMessage(true);
      if (successMessageTimer.current) {
        window.clearTimeout(successMessageTimer.current);
      }
      successMessageTimer.current = window.setTimeout(
        () => setShowSuccessMessage(false),
        3000,
      );

      // ?ªå??·æ–°?¸æ?
      if (typeof (window as any).initializeAppData === "function") {
        (window as any).initializeAppData();
      } else {
        console.log("?·æ–°?½æ•¸?ªå?ç¾©ï??—è©¦?‹å??·æ–°?é¢");
        window.location.reload();
      }
    } catch (error) {
      console.error("???æ¸¬è©¦å¤±æ?:", error);
      // é¡¯ç¤º?´è©³ç´°ç??¯èª¤ä¿¡æ¯
      if (error instanceof Error) {
        console.error("?¯èª¤é¡å?:", error.name);
        console.error("?¯èª¤æ¶ˆæ¯:", error.message);
        console.error("?¯èª¤?†æ£§:", error.stack);
        setError(`???å¤±æ?: ${error.message}`);
      } else {
        setError("???å¤±æ?ï¼Œè?æª¢æŸ¥?§åˆ¶æª¯æ—¥èª?);
      }
      setTimeout(() => setError(null), 5000);
      console.log("===========???æ¸¬è©¦å¤±æ?===========");
    }
  };

  // è®€?–é€šçŸ¥?¸é?
  useEffect(() => {
    if (currentUser) {
      // ?²å?å¥½å?è«‹æ??šçŸ¥
      const fetchNotifications = async () => {
        try {
          const friendRequests = await getFriendRequests();
          const leaderboardInvites = await getLeaderboardInvites();

          // è®€?–æ?è¡Œæ?çµæ??šçŸ¥
          const notificationsRef = collection(db, "notifications");
          const q = query(
            notificationsRef,
            where("type", "==", "leaderboard_ended"),
            where("toUserId", "==", currentUser.uid),
            where("read", "==", false),
          );

          const notificationsSnapshot = await getDocs(q);
          const endedNotifications: any[] = [];

          notificationsSnapshot.forEach((doc) => {
            endedNotifications.push({
              id: doc.id,
              ...doc.data(),
            });
          });

          setLeaderboardEndedNotifications(endedNotifications);
          
          // è®€?–å€Ÿè²¸?°æ??šçŸ¥
          const loanDueQuery = query(
            notificationsRef,
            where("type", "==", "loan_due_warning"),
            where("toUserId", "==", currentUser.uid),
            where("read", "==", false),
          );
          
          const loanDueSnapshot = await getDocs(loanDueQuery);
          const dueNotifications: any[] = [];
          
          loanDueSnapshot.forEach((doc) => {
            dueNotifications.push({
              id: doc.id,
              ...doc.data(),
            });
          });
          
          setLoanDueNotifications(dueNotifications);
          
          // è®€?–å€Ÿè²¸?¾æ??šçŸ¥
          const loanOverdueQuery = query(
            notificationsRef,
            where("type", "==", "loan_overdue"),
            where("toUserId", "==", currentUser.uid),
            where("read", "==", false),
          );
          
          const loanOverdueSnapshot = await getDocs(loanOverdueQuery);
          const overdueNotifications: any[] = [];
          
          loanOverdueSnapshot.forEach((doc) => {
            overdueNotifications.push({
              id: doc.id,
              ...doc.data(),
            });
          });
          
          setLoanOverdueNotifications(overdueNotifications);

          // ?´æ–°?šçŸ¥è¨ˆæ•¸ (å¥½å?è«‹æ? + ?’è?æ¦œé?è«?+ ?’è?æ¦œç??Ÿé€šçŸ¥ + ?Ÿè²¸?°æ??šçŸ¥ + ?Ÿè²¸?¾æ??šçŸ¥)
          setNotificationCount(
            friendRequests.length +
              leaderboardInvites.length +
              endedNotifications.length +
              dueNotifications.length +
              overdueNotifications.length,
          );

          // ä¿å?è«‹æ??Œé?è«‹æ•¸?šä»¥ä¾¿é¡¯ç¤?          setFriendRequestCount(friendRequests.length);
          setLeaderboardInviteCount(leaderboardInvites.length);
        } catch (error) {
          console.error("?²å??šçŸ¥å¤±æ?:", error);
        }
      };

      fetchNotifications();

      // å®šæ?æª¢æŸ¥?šçŸ¥
      const notificationInterval = setInterval(fetchNotifications, 30000); // æ¯?0ç§’æª¢?¥ä?æ¬?
      return () => clearInterval(notificationInterval);
    }
  }, [currentUser, getFriendRequests, getLeaderboardInvites]);

  // ?¾åˆ° formatAmount ?½æ•¸?„å?ç¾?  const formatAmount = (amount: number): string => {
    return amount.toLocaleString("zh-TW", {
      style: "currency",
      currency: "TWD",
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    });
  };

  // ?¾åˆ° calculateTotalAmount ?½æ•¸?„å?ç¾?  const calculateTotalAmount = (expenses: Expense[]): number => {
    return expenses.reduce((total, expense) => total + expense.amount, 0);
  };

  // é¡¯ç¤º?’è?æ¦œç®¡?†é¢??  const handleShowLeaderboardManager = () => {
    console.log("App - ?“é??’è?æ¦œç®¡?†é¢??);

    // æª¢æŸ¥?¯å¦?‰å…¨å±€è®Šé?æ¨™è?
    if (
      typeof window !== "undefined" &&
      (window as any).__shouldShowLeaderboardManager
    ) {
      console.log("App - æª¢æ¸¬?°å…¨å±€è®Šé?__shouldShowLeaderboardManagerï¼Œæ???);
      (window as any).__shouldShowLeaderboardManager = false;
    }

    setShowLeaderboardForm(true);
    setShowSidebar(false);
    setShowExpenseForm(false);
    setShowNotifications(false);

    // ?¶ä??¯èƒ½?€è¦é??‰ç??¢æ¿
    if (setShowProfileForm) setShowProfileForm(false);
    if (setShowFriendManagement) setShowFriendManagement(false);
    if (setShowLeaderboardInvites) setShowLeaderboardInvites(false);
  };

  // ??½è¿”å??’è?æ¦œç®¡?†ä?ä»?  useEffect(() => {
    const handleReturnToLeaderboardManager = () => {
      console.log("App - ?¶åˆ°è¿”å??’è?æ¦œç®¡?†ä?ä»?);
      handleShowLeaderboardManager();
    };

    window.addEventListener(
      "returnToLeaderboardManager",
      handleReturnToLeaderboardManager,
    );
      
      return () => {
      window.removeEventListener(
        "returnToLeaderboardManager",
        handleReturnToLeaderboardManager,
      );
    };
  }, []);

  // ?¹æ??¸å?é¡åˆ¥?æ¿¾?¯å‡º
  const getCategoryExpenses = () => {
    if (!selectedCategory) return [];

    return expenses.filter((expense) => {
      const categoryName =
        typeof expense.category === "string"
          ? expense.category
          : expense.category?.name || "?ªå?é¡?;

      return categoryName === selectedCategory;
    });
  };

  const categoryExpenses = getCategoryExpenses();

  // ?»é??‰é?
  const handleLogin = () => {
    console.log("é»æ??»é??‰é?");
    setLoginFormMode("login");
    setShowLoginForm(true);
  };

  // è¨»å??‰é?
  const handleRegister = () => {
    console.log("é»æ?è¨»å??‰é?");
    setLoginFormMode("register");
    setShowLoginForm(true);
  };

  // ?»é??å??èª¿
  const handleLoginSuccess = () => {
    console.log("æª¢æ¸¬?°ç™»??è¨»å??å?");
    // å»¶é²æª¢æŸ¥?¨æˆ¶?€?‹ï?ç¢ºä? Firebase Auth å·²å??ç??‹æ›´??    setTimeout(() => {
      console.log("å»¶é²æª¢æŸ¥?¨æˆ¶?€??", currentUser ? "å·²ç™»?? : "?ªç™»??);
      if (currentUser) {
        // ?ªæ?ç¢ºè??¨æˆ¶å·²ç™»?„æ??œé?è¡¨å–®
        setShowLoginForm(false);
      }
    }, 800);
  };

  // æ·»å?å°ˆé??¨æ–¼?å??–å?è¡¨ç?useEffect
  useEffect(() => {
    console.log("?–è¡¨?å??–useEffectè§¸ç™¼", "expenses?·åº¦:", expenses?.length);

    // ?¶æ•¸?šå??¨ä?DOMå·²ç?æ¸²æ??‚ï??å??–å?è¡?    if (expenses && expenses.length > 0) {
      console.log("?¸æ?å·²å?è¼‰ï?å»¶é²?å??–å?è¡?);

      // å»¶é²?·è?ä»¥ç¢ºä¿DOMå·²ç?å®Œå…¨æ¸²æ?
      setTimeout(() => {
        try {
          console.log("?‹å??å??–å?é¤…å?");
          if (chartRef.current) {
            initPieChart();
      } else {
            console.warn("?“é??–å®¹?¨DOM?ƒç?ä¸å???);
          }

          console.log("?‹å??å??–æ??¥è¶¨?¢å?");
          if (dailyChartRef.current) {
            initDailyChart();
          } else {
            console.warn("è¶¨å‹¢?–å®¹?¨DOM?ƒç?ä¸å???);
          }
        } catch (error) {
          console.error("?–è¡¨?å??–é?ç¨‹ä¸­?¼ç??¯èª¤:", error);
        }
      }, 300);
    } else {
      console.log("?¡æ?è²»æ•¸?šï??–è€…DOM?ªæ¸²?“ï??µå»ºç©ºå?è¡?);
      setTimeout(() => {
        // ?³ä½¿æ²’æ??¸æ?ï¼Œä??µå»ºç©ºç??–è¡¨ä»¥é¡¯ç¤??«ç„¡?¸æ?"
        if (chartRef.current) {
          createEmptyPieChart();
        }

        if (dailyChartRef.current) {
          createEmptyDailyChart();
        }
      }, 300);
    }
  }, [expenses, selectedCategory]);
  
  // æ·»å?æ³¢ç??ˆæ??•ç?
  useEffect(() => {
    const handleRippleEffect = (event: Event) => {
      const mouseEvent = event as MouseEvent;
      const target = mouseEvent.currentTarget as HTMLElement;
      if (!target || !target.classList.contains('ripple-effect')) return;
      
      const rect = target.getBoundingClientRect();
      const x = mouseEvent.clientX - rect.left;
      const y = mouseEvent.clientY - rect.top;
      
      const ripple = document.createElement('span');
      ripple.style.position = 'absolute';
      ripple.style.left = x + 'px';
      ripple.style.top = y + 'px';
      ripple.style.transform = 'translate(-50%, -50%)';
      ripple.style.width = '0';
      ripple.style.height = '0';
      ripple.style.borderRadius = '50%';
      ripple.style.backgroundColor = 'rgba(255, 255, 255, 0.4)';
      ripple.style.pointerEvents = 'none';
      
      target.appendChild(ripple);
      
      // è¨­ç½®?•ç•«
      requestAnimationFrame(() => {
        ripple.style.transition = 'all 0.6s ease-out';
        ripple.style.width = rect.width * 2.5 + 'px';
        ripple.style.height = rect.width * 2.5 + 'px';
        ripple.style.opacity = '0';
        
        // ?•ç•«çµæ?å¾Œç§»??        setTimeout(() => {
          if (ripple.parentNode === target) {
            target.removeChild(ripple);
          }
        }, 600);
      });
    };
    
    // ?ºæ??‰å…·?‰ripple-effecté¡ç??ƒç?æ·»å?é»æ??ˆæ?
    const rippleElements = document.querySelectorAll('.ripple-effect');
    rippleElements.forEach(el => {
      el.addEventListener('mousedown', handleRippleEffect as EventListener);
    });
      
      return () => {
      rippleElements.forEach(el => {
        el.removeEventListener('mousedown', handleRippleEffect as EventListener);
      });
    };
  }, [showSidebar, showLoginForm, showProfileForm]); // ä¾è³´?¼å¯?½æ??¹è?DOM?„ç???  
  const [showLoanManagement, setShowLoanManagement] = useState(false); // ?Ÿè²¸ç®¡ç?é¡¯ç¤º?€??  const [overdueLoansCount, setOverdueLoansCount] = useState(0); // ?¾æ??Ÿè²¸?¸é?
  
  // æ·»å??´æ–°?¾æ??Ÿè²¸?¸ç?äº‹ä»¶??½??  useEffect(() => {
    const updateOverdueLoansCount = (e: CustomEvent) => {
      if (e.detail && e.detail.count !== undefined) {
        setOverdueLoansCount(e.detail.count);
      }
    };
    
    // å¾localStorage?²å??å??¾æ??Ÿè²¸??    const storedCount = localStorage.getItem('overdueLoansCount');
    if (storedCount) {
      setOverdueLoansCount(Number(storedCount));
    }
    
    // æ·»å?äº‹ä»¶??½??    window.addEventListener('updateOverdueLoansCount', updateOverdueLoansCount as EventListener);
    
    return () => {
      window.removeEventListener('updateOverdueLoansCount', updateOverdueLoansCount as EventListener);
    };
  }, []);
  
  // æ·»å??ç?è¨­ç½®?€??  const [showBudgetSetting, setShowBudgetSetting] = useState(false);
  return (
    <div
      className="min-h-screen bg-gradient-to-br from-elora-cream-light to-white text-gray-800"
      key={renderKey}
    >
{/* ?‚éƒ¨å°èˆª */}
      <nav className={`fixed top-0 left-0 right-0 bg-white bg-opacity-95 backdrop-blur-md shadow-sm z-20 nav-scroll-effect ${navScrolled ? 'scrolled' : ''}`}>
        <div className="flex justify-between items-center px-4 py-3 max-w-5xl mx-auto">
          {/* Left-side navigation items with toggle sidebar button */}
          <div className="flex items-center gap-3">
            {currentUser && (
          <button 
                className="p-2 text-[#A487C3] hover:text-[#8A5DC8] bg-white hover:bg-[#F8F3FF] rounded-lg transition-all duration-300 shadow-sm hover:shadow-md border border-[#F5F5F5] menu-icon-rotate ripple-effect"
                onClick={() => setShowSidebar(!showSidebar)}
          >
            <i className="fas fa-bars"></i>
          </button>
            )}
            <div className="flex items-center">
              <span className="text-lg font-bold text-[#A487C3] nav-logo">
                è¨˜å¸³?¼äººæ®?              </span>
            </div>
        </div>
        
          {/* Right-side navigation items */}
          {currentUser ? (
            <div className="flex items-center gap-3">
              {/* ?šçŸ¥?–æ? */}
              <div className="relative">
                <button 
                  className="p-2 text-[#A487C3] hover:text-[#8A5DC8] bg-white hover:bg-[#F8F3FF] rounded-lg transition-all duration-300 shadow-sm hover:shadow-md border border-[#F5F5F5] focus:outline-none focus:ring-2 focus:ring-white ripple-effect"
                  onClick={() => setShowNotifications(!showNotifications)}
                  style={{ overflow: 'visible' }}
                >
                  <i className="fas fa-bell"></i>
                </button>
                {notificationCount > 0 && (
                  <span className="absolute -top-3 -right-3 bg-red-500 text-white text-xs font-bold rounded-full w-7 h-7 flex items-center justify-center shadow-lg z-50 notification-badge border-2 border-white">
                    {notificationCount}
                  </span>
                )}
              </div>

              {/* ?¨æˆ¶?­å? */}
              <div
                className="flex items-center cursor-pointer hover:bg-[#F8F3FF] rounded-lg p-1 transition-all duration-300 nav-item ripple-effect"
                onClick={() => setShowProfileForm(!showProfileForm)}
              >
                <div className="w-8 h-8 rounded-full bg-[#A487C3] shadow-md overflow-hidden flex items-center justify-center">
                  {currentUser.photoURL ? (
                    <img
                      src={currentUser.photoURL}
                      alt="?¨æˆ¶?­å?"
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <span className="text-white font-medium">
                      {userNickname
                        ? userNickname.charAt(0).toUpperCase()
                        : currentUser.email
                          ? currentUser.email.charAt(0).toUpperCase()
                          : "?"}
                    </span>
                  )}
                </div>
              </div>

              {/* ?»å‡º?‰é? */}
              <button 
                onClick={() => logout()}
                className="p-2 text-[#FAC6CD] hover:text-[#E57B9E] bg-white hover:bg-[#FFF6F8] rounded-lg transition-all duration-300 shadow-sm hover:shadow-md border border-[#F5F5F5] ripple-effect"
              >
                <i className="fas fa-sign-out-alt"></i>
              </button>
            </div>
          ) : (
            <div className="flex items-center gap-2">
            <button 
                onClick={handleLogin}
                className="py-2 px-4 bg-[#A487C3] hover:bg-[#8A5DC8] text-white rounded-lg transition-all duration-300 shadow-sm hover:shadow-md focus:outline-none focus:bg-white focus:text-[#A487C3] focus:border focus:border-[#A487C3] nav-item ripple-effect"
            >
                ?»å…¥
            </button>
              <button
                onClick={handleRegister}
                className="py-2 px-4 bg-white hover:bg-[#F8F3FF] text-[#A487C3] hover:text-[#8A5DC8] border border-[#A487C3] rounded-lg transition-all duration-300 shadow-sm hover:shadow-md focus:outline-none focus:bg-white nav-item ripple-effect"
              >
                è¨»å?
              </button>
            </div>
          )}
        </div>
      </nav>
      
      {/* ä¸»è??§å®¹?€ - ?ªæ??»å…¥?¨æˆ¶?èƒ½?‹åˆ° */}
      {currentUser ? (
        <div className="pt-24 px-4 md:px-8 pb-8 max-w-5xl mx-auto">
          <div className="mb-6">
            <h1 className="text-2xl font-bold text-[#A487C3] mb-1 font-heading">
              æ­¡è??ä?ï¼Œ{userNickname || currentUser.email?.split("@")[0]}
            </h1>
            <p className="text-[#6E6E6E]">
              ä»Šå¤©?¯{" "}
              {new Date().toLocaleDateString("zh-TW", {
                year: "numeric",
                month: "long",
                day: "numeric",
                weekday: "long",
              })}
            </p>
          </div>
          
          {/* æ·»å?çµ±è??¡ç? */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            {/* ç¸½æ”¯?ºå¡??*/}
            <div 
              className="bg-gradient-to-br from-elora-purple to-elora-purple-light text-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-500 transform hover:-translate-y-1"
              style={{animation: 'fadeSlideIn 0.6s ease-out both'}}
            >
              <div className="p-5 flex items-center justify-between">
                <div>
                  <p className="text-white text-opacity-80 mb-1">?¬æ?æ¶ˆè²»?‘é?</p>
                  <h3 className="text-2xl font-bold">
                    {new Intl.NumberFormat("zh-TW", {
                      style: "currency",
                      currency: "TWD",
                      minimumFractionDigits: 0,
                      maximumFractionDigits: 0,
                    }).format(
                      expenses
                        .filter(expense => {
                          const today = new Date();
                          const currentMonth = today.getMonth();
                          const currentYear = today.getFullYear();
                          const expenseDate = new Date(expense.date);
                          return expenseDate.getMonth() === currentMonth && 
                                 expenseDate.getFullYear() === currentYear;
                        })
                        .reduce((total, expense) => total + expense.amount, 0)
                    )}
                  </h3>
                </div>
                <div className="w-12 h-12 rounded-xl bg-white bg-opacity-20 flex items-center justify-center">
                  <i className="fas fa-wallet text-xl"></i>
                </div>
              </div>
              <div className="bg-white bg-opacity-10 px-5 py-2 text-sm">
                <span>
                  {expenses
                    .filter(expense => {
                      const today = new Date();
                      const currentMonth = today.getMonth();
                      const currentYear = today.getFullYear();
                      const expenseDate = new Date(expense.date);
                      return expenseDate.getMonth() === currentMonth && 
                             expenseDate.getFullYear() === currentYear;
                    })
                    .length} ç­†æœ¬?ˆè???                </span>
              </div>
            </div>
            
            {/* ä»Šæ—¥?¯å‡º?¡ç? */}
            <div 
              className="bg-gradient-to-br from-[#E07A8D] to-[#F09CA7] text-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-500 transform hover:-translate-y-1"
              style={{animation: 'fadeSlideIn 0.6s ease-out 0.2s both'}}
            >
              <div className="p-5 flex items-center justify-between">
                <div>
                  <p className="text-white text-opacity-90 mb-1 font-medium">ä»Šæ—¥æ¶ˆè²»</p>
                  <h3 className="text-2xl font-bold">
                    {new Intl.NumberFormat("zh-TW", {
                      style: "currency",
                      currency: "TWD",
                      minimumFractionDigits: 0,
                      maximumFractionDigits: 0,
                    }).format(
                      expenses
                        .filter(expense => {
                          const today = new Date();
                          today.setHours(0, 0, 0, 0);
                          const expenseDate = new Date(expense.date);
                          expenseDate.setHours(0, 0, 0, 0);
                          return expenseDate.getTime() === today.getTime();
                        })
                        .reduce((total, expense) => total + expense.amount, 0)
                    )}
                  </h3>
                </div>
                <div className="w-12 h-12 rounded-xl bg-white bg-opacity-20 flex items-center justify-center">
                  <i className="fas fa-calendar-day text-xl"></i>
                </div>
              </div>
              <div className="bg-white bg-opacity-10 px-5 py-2 text-sm">
                <span>
                  {expenses
                    .filter(expense => {
                      const today = new Date();
                      today.setHours(0, 0, 0, 0);
                      const expenseDate = new Date(expense.date);
                      expenseDate.setHours(0, 0, 0, 0);
                      return expenseDate.getTime() === today.getTime();
                    })
                    .length} ç­†ä??¥è???                </span>
              </div>
            </div>
          </div>
          
          {/* å¿«é€Ÿè?å¸³æ???*/}
          <div className="mb-8 relative flex gap-2">
            <button 
              className="px-5 py-3 bg-[#E07A8D] hover:bg-[#F09CA7] text-white rounded-xl shadow-sm hover:shadow-md flex items-center gap-2 font-medium transition-all duration-300"
              onClick={() => setShowExpenseForm(true)}
            >
              <i className="fas fa-plus"></i>
              <span>?°å?æ¶ˆè²»?ç´°</span>
            </button>
          </div>
          
          {/* ?å??ç¤ºæ¶ˆæ¯ - ?ºå??¨ç•«?¢ä¸­å¤?*/}
          {showSuccessMessage && (
            <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gradient-to-r from-[#6BCB77] to-[#89D8B0] text-white px-6 py-3 rounded-lg shadow-lg flex items-center z-[9999] text-lg font-medium animate-fade-in">
              <i className="fas fa-check-circle mr-3 text-xl"></i>
              <span>{successMessage}</span>
</div>
          )}
          
          {/* é¡¯ç¤º?¯èª¤æ¶ˆæ¯?„é€šçŸ¥ */}
          {error && (
            <div className="fixed top-16 left-0 right-0 mx-auto w-11/12 max-w-md bg-red-50 text-elora-pink p-3 rounded shadow-lg transition-all duration-300 ease-in-out z-50 flex items-center justify-between">
              <div className="flex items-center">
                <i className="fas fa-exclamation-circle mr-2"></i>
                <span>{error}</span>
</div>
              <button
                onClick={() => setError(null)}
                className="text-elora-pink hover:text-elora-pink-light"
              >
                <i className="fas fa-times"></i>
              </button>
</div>
          )}
          
          {/* ?¯å‡º?†æ??¡ç? */}
          <div className="relative bg-white bg-opacity-95 backdrop-blur-sm rounded-xl shadow-md border-l-4 border-elora-purple p-5 mb-6 hover:shadow-lg transition-all duration-300">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg font-bold text-elora-purple">?¯å‡º?†æ?</h2>
              {selectedCategory && (
                <button
                  onClick={resetCategorySelection}
                  className="text-sm text-white bg-elora-purple hover:bg-elora-purple-light px-4 py-1.5 rounded-lg flex items-center transition-all duration-300 shadow-sm hover:shadow-md"
                >
                  <i className="fas fa-arrow-left mr-1.5"></i> è¿”å?ç¸½è¦½
                </button>
              )}
            </div>
            <div className="flex flex-col md:flex-row">
              <div
                className={`${selectedCategory ? "md:w-3/5" : "w-full"} transition-all duration-300`}
              >
            {expenses && expenses.length > 0 ? (
                  <div
                    ref={chartRef}
                    style={{
                      height: "260px", // ?Ÿå???"300px"ï¼Œæ?å°é?åº?                      width: "100%",
                      display: "flex",
                      justifyContent: "center",
                      alignItems: "center",
                    }}
                    key={`pie-chart-${selectedCategory ? "selected" : "overview"}-${chartsKey}`}
                  />
            ) : (
              <div className="text-center py-8 text-gray-500 h-[260px] flex flex-col items-center justify-center">
                    <i className="fas fa-chart-pie text-3xl mb-2 text-elora-purple opacity-40"></i>
                    <p className="mb-3">æ²’æ?ä»»ä?æ¶ˆè²»?ç´°</p>
                <button 
                  className="px-4 py-2 bg-[#E07A8D] hover:bg-[#F09CA7] text-white rounded-lg text-sm shadow-sm hover:shadow-md transition-all duration-300 ripple-effect floating"
                  onClick={() => setShowExpenseForm(true)}
                >
                  <i className="fas fa-plus-circle mr-2"></i>
                  ?°å?æ¶ˆè²»?ç´°
                </button>
</div>
)}
              </div>

              {/* ?¸å?é¡åˆ¥?¯å‡º?ç´° */}
              {selectedCategory && (
                <div className="md:w-2/5 md:pl-4 mt-4 md:mt-0">
                  <div className="bg-gradient-to-br from-elora-cream-light to-white rounded-lg p-3 h-[300px] overflow-y-auto shadow-inner">
                    <h3 className="font-medium text-[#2E2E2E] mb-3 flex items-center">
                      <i
                        className={`fas ${getCategoryIcon(selectedCategory)} mr-2`}
                        style={{ color: getCategoryColor(selectedCategory) }}
                      ></i>
                      {selectedCategory} ?¯å‡º?ç´°
                    </h3>

                    {categoryExpenses.length > 0 ? (
                      <div className="space-y-3">
                        {categoryExpenses.map((expense, index) => (
                          <div
                            key={expense.id}
                            className="bg-white p-3 rounded-lg shadow-sm border-l-2 border-elora-purple hover:shadow-md transition-all duration-300"
                            style={{
                              animation: `fadeSlideIn 0.5s ease-out ${index * 0.1}s both`,
                              opacity: 0,
                              transform: 'translateY(20px)'
                            }}
                          >
                            <div className="flex justify-between items-center">
                              <div className="flex items-center">
                                <span className="font-medium text-[#2E2E2E]">
                                  {formatAmount(expense.amount)}
                                </span>
                                {expense.notes && (
                                  <span className="text-xs text-[#6E6E6E] ml-2">
                                    {expense.notes.length > 10
                                      ? `${expense.notes.substring(0, 10)}...`
                                      : expense.notes}
                                  </span>
                                )}
                              </div>
                              <span className="text-sm text-[#6E6E6E]">
                                {expense.date.toLocaleDateString()}
                              </span>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="text-center py-4 text-[#6E6E6E]">
                        <p>æ²’æ??¾åˆ° {selectedCategory} é¡åˆ¥?„æ”¯??/p>
                      </div>
                    )}

                    <div className="mt-4 pt-2 border-t border-gray-200">
                      <p className="text-right font-medium text-[#2E2E2E]">
                        ç¸½è?:{" "}
                        {formatAmount(
                          categoryExpenses.reduce(
                            (total, exp) => total + exp.amount,
                            0,
                          ),
                        )}
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </div>
</div>

          {/* æ¯æ—¥æ¶ˆè²»?·æ???*/}
          <div className="bg-white bg-opacity-95 backdrop-blur-sm rounded-xl shadow-md border-l-4 border-elora-mint p-5 mb-6 hover:shadow-lg transition-all duration-300">
            <h2 className="text-lg font-bold text-[#6BBFA0] mb-4">
              æ¯æ—¥æ¶ˆè²»è¶¨å‹¢
            </h2>
            {expenses && expenses.length > 0 ? (
              <div
                ref={dailyChartRef}
                style={{ height: "300px" }}
                key={`daily-chart-${expenses.length}`}
              ></div>
            ) : (
              <div className="text-center py-8 text-gray-500 h-[300px] flex flex-col items-center justify-center">
                <i className="fas fa-chart-bar text-3xl mb-2 text-elora-mint opacity-40"></i>
                <p className="mb-3">æ²’æ?ä»»ä?æ¶ˆè²»?ç´°</p>
                <button 
                  className="px-4 py-2 bg-[#E07A8D] hover:bg-[#F09CA7] text-white rounded-lg text-sm shadow-sm hover:shadow-md transition-all duration-300 ripple-effect floating"
                  onClick={() => setShowExpenseForm(true)}
                >
                  <i className="fas fa-plus-circle mr-2"></i>
                  ?°å?æ¶ˆè²»?ç´°
                </button>
</div>
)}
          </div>
          
          {/* ä»Šæ—¥?¯å‡º - ?¾åœ¨æ¯æ—¥æ¶ˆè²»è¶¨å‹¢ä¸‹æ–¹ */}
          <div className="bg-white bg-opacity-95 rounded-xl shadow-md border-l-4 border-elora-pink p-5 mb-6">
            <div className="flex flex-col mb-4">
              {/* ?ªé™¤?¸é??¡å???*/}
              
              <div className="mb-3">
                <h2 className="text-xl font-bold text-elora-pink">
                  {selectedDateOption === "today"
                    ? "ä»Šæ—¥æ¶ˆè²»?ç´°"
                    : selectedDateOption === "yesterday"
                      ? "?¨æ—¥æ¶ˆè²»?ç´°"
                      : selectedDateOption === "month"
                        ? "?¬æ?æ¶ˆè²»?ç´°"
                        : selectedDateOption === "this_week"
                          ? "?¬é€±æ?è²»æ?ç´?
                          : selectedDateOption === "last_week"
                            ? "ä¸Šé€±æ?è²»æ?ç´?
                            : selectedDateOption === "month_select"
                              ? `${selectedMonth.split('-')[0]}å¹?{selectedMonth.split('-')[1]}?ˆæ?è²»æ?ç´°`
                              : selectedDateOption === "earlier"
                                ? format(selectedDate, "yyyyå¹´M?ˆd??) + " æ¶ˆè²»?ç´°"
                                : "?¨éƒ¨æ¶ˆè²»?ç´°"}
                </h2>
              </div>

              {/* ?¥æ??‡æ??‰é? - ç°¡ç??ªé?è¨­è? */}
              <div className="flex flex-wrap gap-1.5 mb-4">
                <button
                  onClick={() => {
                    setSelectedDate(getTodayDate());
                    setSelectedDateOption("today");
                  }}
                  className={`px-3 py-1.5 text-xs rounded-md flex items-center gap-1 transition-colors duration-200 ${
                    selectedDateOption === "today"
                      ? "bg-[#8A7C9F] text-white border border-[#8A7C9F]"
                      : "bg-[#F9F7FB] text-[#6D6D6D] border border-[#E8E4ED] hover:bg-[#F2EDF7]"
                  }`}
                >
                  <i className="fas fa-calendar-day text-[10px]"></i>
                  ä»Šå¤©
                </button>
                <button
                  onClick={() => {
                    const yesterday = new Date(getTodayDate());
                    yesterday.setDate(yesterday.getDate() - 1);
                    setSelectedDate(yesterday);
                    setSelectedDateOption("yesterday");
                  }}
                  className={`px-3 py-1.5 text-xs rounded-md flex items-center gap-1 transition-colors duration-200 ${
                    selectedDateOption === "yesterday"
                      ? "bg-[#8A7C9F] text-white border border-[#8A7C9F]"
                      : "bg-[#F9F7FB] text-[#6D6D6D] border border-[#E8E4ED] hover:bg-[#F2EDF7]"
                  }`}
                >
                  <i className="fas fa-calendar-minus text-[10px]"></i>
                  ?¨å¤©
                </button>
                <button
                  onClick={() => {
                    // ?²å??¬é€±ç?èµ·å??¥æ?
                    const today = new Date();
                    const currentDay = today.getDay() || 7; // ?•ç??±æ—¥???„æ?æ³?                    const firstDayOfWeek = new Date(today);
                    firstDayOfWeek.setDate(today.getDate() - (currentDay - 1));
                    firstDayOfWeek.setHours(0, 0, 0, 0);
                    setSelectedDate(firstDayOfWeek);
                    setSelectedDateOption("this_week");
                  }}
                  className={`px-3 py-1.5 text-xs rounded-md flex items-center gap-1 transition-colors duration-200 ${
                    selectedDateOption === "this_week"
                      ? "bg-[#8A7C9F] text-white border border-[#8A7C9F]"
                      : "bg-[#F9F7FB] text-[#6D6D6D] border border-[#E8E4ED] hover:bg-[#F2EDF7]"
                  }`}
                >
                  <i className="fas fa-calendar-week text-[10px]"></i>
                  ?¬é€?                </button>
                <button
                  onClick={() => {
                    // ?²å?ä¸Šé€±ç?èµ·å??¥æ?
                    const today = new Date();
                    const currentDay = today.getDay() || 7; // ?•ç??±æ—¥???„æ?æ³?                    const firstDayOfLastWeek = new Date(today);
                    firstDayOfLastWeek.setDate(today.getDate() - (currentDay - 1) - 7);
                    firstDayOfLastWeek.setHours(0, 0, 0, 0);
                    setSelectedDate(firstDayOfLastWeek);
                    setSelectedDateOption("last_week");
                  }}
                  className={`px-3 py-1.5 text-xs rounded-md flex items-center gap-1 transition-colors duration-200 ${
                    selectedDateOption === "last_week"
                      ? "bg-[#8A7C9F] text-white border border-[#8A7C9F]"
                      : "bg-[#F9F7FB] text-[#6D6D6D] border border-[#E8E4ED] hover:bg-[#F2EDF7]"
                  }`}
                >
                  <i className="fas fa-calendar-alt text-[10px]"></i>
                  ä¸Šé€?                </button>
                <button
                  onClick={() => {
                    setSelectedDateOption("month");
                  }}
                  className={`px-3 py-1.5 text-xs rounded-md flex items-center gap-1 transition-colors duration-200 ${
                    selectedDateOption === "month"
                      ? "bg-[#8A7C9F] text-white border border-[#8A7C9F]"
                      : "bg-[#F9F7FB] text-[#6D6D6D] border border-[#E8E4ED] hover:bg-[#F2EDF7]"
                  }`}
                >
                  <i className="fas fa-calendar text-[10px]"></i>
                  ?¬æ?
                </button>
                <button
                  onClick={() => {
                    setShowDatePicker(true);
                  }}
                  className={`px-3 py-1.5 text-xs rounded-md flex items-center gap-1 transition-colors duration-200 ${
                    selectedDateOption === "earlier"
                      ? "bg-[#8A7C9F] text-white border border-[#8A7C9F]"
                      : "bg-[#F9F7FB] text-[#6D6D6D] border border-[#E8E4ED] hover:bg-[#F2EDF7]"
                  }`}
                >
                  <i className="fas fa-calendar-plus text-[10px]"></i>
                  ?¸æ??¥æ?
                </button>
                <button
                  onClick={() => {
                    // ?“é??¸æ??ˆä»½å°è©±æ¡?                    setShowMonthPicker(true);
                  }}
                  className={`px-3 py-1.5 text-xs rounded-md flex items-center gap-1 transition-colors duration-200 ${
                    selectedDateOption === "month_select"
                      ? "bg-[#8A7C9F] text-white border border-[#8A7C9F]"
                      : "bg-[#F9F7FB] text-[#6D6D6D] border border-[#E8E4ED] hover:bg-[#F2EDF7]"
                  }`}
                >
                  <i className="fas fa-calendar-alt text-[10px]"></i>
                  ?¸æ??ˆä»½
                </button>
                <button
                  onClick={() => {
                    setSelectedDateOption("all");
                  }}
                  className={`px-3 py-1.5 text-xs rounded-md flex items-center gap-1 transition-colors duration-200 ${
                    selectedDateOption === "all"
                      ? "bg-[#8A7C9F] text-white border border-[#8A7C9F]"
                      : "bg-[#F9F7FB] text-[#6D6D6D] border border-[#E8E4ED] hover:bg-[#F2EDF7]"
                  }`}
                >
                  <i className="fas fa-infinity text-[10px]"></i>
                  ?¨éƒ¨
                </button>
              </div>
            </div>

            <p className="text-gray-500">
              ç¸½è?:{" "}
              {filteredTransactions.length > 0
                ? new Intl.NumberFormat("zh-TW", {
                    style: "currency",
                    currency: "TWD",
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                  }).format(
                    filteredTransactions.reduce(
                      (total, expense) => total + expense.amount,
                      0,
                    ),
                  )
                : "$0"}
            </p>

            {filteredTransactions.length > 0 ? (
              <>
              <div className="space-y-4">
                  {filteredTransactions.map((transaction) => (
                    <div
                      key={transaction.id}
                      className="flex items-center justify-between pb-3 border-b border-gray-100 last:border-0"
                    >
                    <div className="flex items-center gap-3">
                        <div
                          className="w-12 h-12 rounded-lg flex items-center justify-center text-white"
                          style={{
                            backgroundColor: getCategoryColor(
                              typeof transaction.category === "string"
                                ? transaction.category
                                : transaction.category?.name || "?¶ä?",
                            ),
                          }}
                        >
                          <i
                            className={`fas ${typeof transaction.category === "string" ? getCategoryIcon(transaction.category) : transaction.category?.icon || "fa-question"} text-xl`}
                          ></i>
                      </div>
                      <div>
                          <p className="font-medium text-gray-800">
                            {typeof transaction.category === "string"
                              ? transaction.category
                              : transaction.category?.name || "?ªå?é¡?}
                            {transaction.notes && (
                              <span className="ml-2 font-normal text-gray-500 text-sm">
                                {transaction.notes.length > 30
                                  ? `${transaction.notes.substring(0, 30)}...`
                                  : transaction.notes}
                              </span>
                            )}
                          </p>
                          <p className="text-sm text-gray-500">
                            {transaction.date.toLocaleDateString()}
                          </p>
</div>
</div>
                      <div className="flex items-center gap-3">
                        <p className="font-medium text-gray-700">
                          NT$ {transaction.amount}
                        </p>
                        <div className="flex gap-2">
                        <button 
                          onClick={() => editExpense(transaction)}
                            className="w-10 h-10 flex items-center justify-center text-gray-600 hover:text-white bg-[#E0D4F0] hover:bg-blue-500 rounded-full transition-all duration-200"
                            title="ç·¨è¼¯æ¶ˆè²»?ç´°"
                        >
                            <i className="fas fa-edit text-lg"></i>
                        </button>
                        <button 
                          onClick={(e) => {
                            e.preventDefault(); // ?»æ­¢é»˜è?è¡Œç‚º
                            e.stopPropagation(); // ?»æ­¢äº‹ä»¶?’æ³¡
                              console.log(
                                "?ƒåœ¾æ¡¶æ??•é??Šï?ID:",
                                transaction.id,
                              );
                            deleteExpense(transaction.id);
                          }}
                            className="w-10 h-10 flex items-center justify-center text-gray-600 hover:text-white bg-[#E0D4F0] hover:bg-red-500 rounded-full transition-all duration-200"
                            title="?ªé™¤æ¶ˆè²»?ç´°"
                        >
                            <i className="fas fa-trash text-lg"></i>
                        </button>
                      </div>
                    </div>
</div>
))}
</div>
                <div className="mt-6 pt-4 border-t border-gray-200 flex justify-end">
                  <p className="text-lg font-bold text-gray-800">
                    ç¸½è?:{" "}
                    {new Intl.NumberFormat("zh-TW", {
                      style: "currency",
                      currency: "TWD",
                      minimumFractionDigits: 0,
                      maximumFractionDigits: 0,
                    }).format(
                      filteredTransactions.reduce(
                        (total, expense) => total + expense.amount,
                        0,
                      ),
                    )}
                  </p>
                </div>
              </>
            ) : (
              <div className="text-center py-8 text-gray-500 flex flex-col items-center justify-center h-[200px]">
                <i className="fas fa-receipt text-3xl mb-2 text-gray-300"></i>
                <p className="mb-3">
                  {selectedDateOption === "today"
                    ? "ä»Šå¤©?„æ??‰è??„ä»»ä½•æ?è²?
                    : selectedDateOption === "yesterday"
                      ? "?¨å¤©æ²’æ?æ¶ˆè²»è¨˜é?"
                      : selectedDateOption === "month"
                        ? "?¬æ?æ²’æ?æ¶ˆè²»è¨˜é?"
                        : `${format(selectedDate, "yyyyå¹´M?ˆd??)} æ²’æ?æ¶ˆè²»è¨˜é?`}
                </p>
                <button 
                  className="px-4 py-2 bg-[#E07A8D] hover:bg-[#F09CA7] text-white rounded-lg text-sm shadow-sm hover:shadow-md transition-all duration-300 ripple-effect floating"
                  onClick={() => setShowExpenseForm(true)}
                >
                  <i className="fas fa-plus-circle mr-2"></i>
                  ?°å?æ¶ˆè²»?ç´°
</button>
</div>
            )}
</div>
</div>
      ) : (
        <div className="pt-24 px-4 md:px-8 pb-8 max-w-5xl mx-auto text-center">
          <div className="bg-white bg-opacity-95 rounded-xl shadow-sm p-8 mb-6 max-w-md mx-auto">
            <h2 className="text-2xl font-bold text-gray-800 mb-4 font-heading">
              è«‹å??»å…¥
            </h2>
            <p className="text-gray-600 mb-6">?¨é?è¦ç™»?¥æ??½ä½¿?¨è?å¸³å???/p>
            <button 
              onClick={() => setShowLoginForm(true)}
              className="px-6 py-3 bg-pastel-pink-400 hover:bg-pastel-pink-300 text-white rounded-lg font-medium transition-colors"
            >
              ?»å…¥ / è¨»å?
            </button>
</div>
</div>
      )}
      
      {/* ?´é?æ¬?*/}
      {showSidebar && currentUser && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-30 sidebar-backdrop">
          <div className="fixed top-0 left-0 w-64 h-full bg-gradient-to-b from-white to-elora-cream-light shadow-lg transform translate-x-0 transition-transform z-40 overflow-y-auto sidebar-3d-effect">
            {/* ?´é?æ¬„é???*/}
            <div className="p-4 border-b border-gray-100">
              <div className="flex flex-col">
                <h3 className="font-bold text-[#2E2E2E] mb-3">?¸å–®</h3>
                <div className="flex items-center gap-3">
                  <div className="w-12 h-12 rounded-full bg-gradient-to-r from-elora-purple to-elora-pink overflow-hidden flex items-center justify-center flex-shrink-0 shadow-md">
                    {currentUser.photoURL ? (
                      <img
                        src={currentUser.photoURL}
                        alt="?¨æˆ¶?­å?"
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <span className="text-white font-medium text-xl">
                        {userNickname
                          ? userNickname.charAt(0).toUpperCase()
                          : currentUser.email
                            ? currentUser.email.charAt(0).toUpperCase()
                            : "?"}
                      </span>
                    )}
</div>
                  <div className="flex-1 min-w-0">
                    <p className="font-medium text-[#2E2E2E] truncate">
                      {userNickname ||
                        currentUser.email?.split("@")[0] ||
                        "?¨æˆ¶"}
                    </p>
                    <p className="text-xs text-[#6E6E6E] truncate">
                      {currentUser.email}
                    </p>
                    </div>
                </div>
              </div>
            </div>

            {/* ?´é?æ¬„é¸??- ä½¿ç”¨æ¼¸è??²è???*/}
            <div className="p-4">
                <button 
                      onClick={() => {
                        setShowSidebar(false);
                  setShowProfileForm(true);
                }}
                className="flex items-center gap-3 w-full p-3 text-left text-white bg-[#C6B2DD] hover:bg-[#D8CAEB] rounded-lg mb-2 shadow-sm transition-all duration-300 sidebar-menu-item sidebar-menu-item-1 tilt-hover ripple-effect"
                style={{opacity: 1, transform: 'none'}}
              >
                <div className="w-8 h-8 rounded-full bg-white bg-opacity-20 flex items-center justify-center backdrop-blur-sm">
                  <i className="fas fa-user text-white"></i>
</div>
                <span>?‹äººè³‡æ?</span>
                    </button>

                    <button 
                      onClick={() => {
                        setShowSidebar(false);
                  setShowLeaderboardViewer(true);
                }}
                className="flex items-center gap-3 w-full p-3 text-left text-white bg-[#C6B2DD] hover:bg-[#D8CAEB] rounded-lg mb-2 shadow-sm transition-all duration-300 sidebar-menu-item sidebar-menu-item-2 tilt-hover ripple-effect"
                style={{opacity: 1, transform: 'none'}}
              >
                <div className="w-8 h-8 rounded-full bg-white bg-opacity-20 flex items-center justify-center backdrop-blur-sm">
                  <i className="fas fa-list-ol text-white"></i>
                </div>
                <span>?’è?æ¦?/span>
                    </button>

                    <button 
                      onClick={() => {
                        setShowSidebar(false);
                  setShowFriendManagement(true);
                }}
                className="flex items-center gap-3 w-full p-3 text-left text-white bg-[#C6B2DD] hover:bg-[#D8CAEB] rounded-lg mb-2 relative shadow-sm transition-all duration-300 sidebar-menu-item sidebar-menu-item-3 tilt-hover ripple-effect"
                style={{opacity: 1, transform: 'none'}}
              >
                <div className="w-8 h-8 rounded-full bg-white bg-opacity-20 flex items-center justify-center backdrop-blur-sm">
                  <i className="fas fa-user-friends text-white"></i>
                </div>
                <span>å¥½å?ç®¡ç?</span>
                {friendRequestCount > 0 && (
                  <span className="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center transform -translate-y-1 translate-x-1 shadow-md z-20 notification-badge animate-pulse">
                    {friendRequestCount}
                  </span>
                )}
                    </button>

{/* æ·»å??Ÿè²¸ç®¡ç??¸é? */}
<button
                      onClick={() => {
                        setShowSidebar(false);
    setShowLoanManagement(true);
  }}
  className="flex items-center gap-3 w-full p-3 text-left text-white bg-[#C6B2DD] hover:bg-[#D8CAEB] rounded-lg mb-2 relative shadow-sm transition-all duration-300 sidebar-menu-item sidebar-menu-item-4 tilt-hover ripple-effect"
  style={{opacity: 1, transform: 'none'}}
>
  <div className="w-8 h-8 rounded-full bg-white bg-opacity-20 flex items-center justify-center backdrop-blur-sm">
    <i className="fas fa-hand-holding-usd text-white"></i>
  </div>
  <span>?Ÿè²¸ç®¡ç?</span>
  {overdueLoansCount > 0 && (
    <span className="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center transform -translate-y-1 translate-x-1 shadow-md z-20 notification-badge animate-pulse">
      {overdueLoansCount}
    </span>
  )}
</button>

{/* æ·»å?å¥½å??†å¸³?¸é? */}
<button
                      onClick={() => {
                        setShowSidebar(false);
  }}
  className="flex items-center gap-3 w-full p-3 text-left text-white bg-[#C6B2DD] hover:bg-[#D8CAEB] rounded-lg mb-2 relative shadow-sm transition-all duration-300 sidebar-menu-item sidebar-menu-item-5 tilt-hover ripple-effect"
  style={{opacity: 1, transform: 'none'}}
>
  <div className="w-8 h-8 rounded-full bg-white bg-opacity-20 flex items-center justify-center backdrop-blur-sm">
    <i className="fas fa-receipt text-white"></i>
  </div>
  <span>å¥½å??†å¸³</span>
</button>

{/* æ·»å??ç?è¨­ç½®?¸é? */}
                  <button 
                    onClick={() => {
                      setShowSidebar(false);
    setShowBudgetSetting(true);
  }}
  className="flex items-center gap-3 w-full p-3 text-left text-white bg-[#C6B2DD] hover:bg-[#D8CAEB] rounded-lg mb-2 relative shadow-sm transition-all duration-300 sidebar-menu-item sidebar-menu-item-6 tilt-hover ripple-effect"
  style={{opacity: 1, transform: 'none'}}
>
  <div className="w-8 h-8 rounded-full bg-white bg-opacity-20 flex items-center justify-center backdrop-blur-sm">
    <i className="fas fa-money-bill-wave text-white"></i>
  </div>
  <span>è¨­ç½®?ç?</span>
                  </button>
              </div>
              
            {/* ?†é?ç·?*/}
            <div className="border-t border-gray-200 my-2"></div>

            {/* åº•éƒ¨?¸é? - ?»å‡º?‰é? */}
            <div className="p-4">
                  <button 
                    onClick={() => {
                  logout();
                      setShowSidebar(false);
                }}
                className="flex items-center gap-3 w-full p-3 text-left text-white bg-[#FAC6CD] hover:bg-[#FFE2E5] rounded-lg mb-2 shadow-sm transition-all duration-300 sidebar-menu-item sidebar-menu-item-6 tilt-hover ripple-effect"
                style={{opacity: 1, transform: 'none'}} // ç¢ºä??‰é?ä¸€å®šå¯è¦?              >
                <div className="w-8 h-8 rounded-full bg-white bg-opacity-20 flex items-center justify-center backdrop-blur-sm">
                  <i className="fas fa-sign-out-alt text-white"></i>
                </div>
                <span>?»å‡º</span>
                  </button>
              </div>
            </div>

          {/* é»æ?ç©ºç™½?•é??‰å´?Šæ? */}
          <div 
            className="absolute inset-0"
            onClick={() => setShowSidebar(false)}
          ></div>
</div>
)}
      
      {/* ?»å…¥/è¨»å?è¡¨å–® */}
      {showLoginForm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fadeIn">
          <div className="relative bg-white rounded-xl shadow-lg max-w-md w-full" style={{animation: 'slideUpIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) both'}}>
            <button
              onClick={() => setShowLoginForm(false)}
              className="absolute top-4 right-4 text-white hover:text-white bg-[#A487C3] hover:bg-[#8A5DC8] w-8 h-8 flex items-center justify-center border border-[#F5F5F5] rounded-full shadow-sm hover:shadow-md transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-white"
            >
              <i className="fas fa-times"></i>
            </button>
            <div className="p-6" style={{animation: 'fadeIn 0.5s 0.2s both'}}>
              <LoginForm 
                onSuccess={handleLoginSuccess}
                initialMode={loginFormMode}
              />
</div>
</div>
</div>
      )}
      
      {/* æ·»å??¯å‡ºè¡¨å–® */}
      {showExpenseForm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fadeIn">
          <div 
            className="relative bg-white rounded-xl shadow-lg max-w-md w-full"
            style={{animation: 'slideUpIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) both'}}
          >
            <div className="p-6" style={{animation: 'fadeIn 0.5s 0.2s both', position: 'relative', zIndex: 10}}>
              <ExpenseForm 
                onSave={async (data) => {
                  try {
                    console.log("æº–å?ä¿å??¯å‡º:", data);
                    
                    // ç«‹å³?œé?è¡¨å–®ï¼Œæ?é«˜ç”¨?¶é?é©?                    setShowExpenseForm(false);
                    setEditingExpense(null);
                    
                    // ?´æ¥?·è?ä¿å??ä?
                    let success = false;
                    
                    if (editingExpense) {
                      success = await updateExpense(data);
                      if (success) {
                        setSuccessMessage("?¯å‡ºå·²æ›´?°ï?");
                        // å¼·åˆ¶?æ–°æ¸²æ?
                        forceRerender();
                      }
                    } else {
                      success = await addExpense(data);
                      if (success) {
                        setSuccessMessage("è¨˜å¸³?å?ï¼?);
                        // å¼·åˆ¶?æ–°æ¸²æ?
                        forceRerender();
                      }
                    }
                    
                    if (success) {
                      // é¡¯ç¤º?å?æ¶ˆæ¯
                      setShowSuccessMessage(true);
                      console.log("é¡¯ç¤º?å?æ¶ˆæ¯");
                      // è¨­ç½®å®šæ??¨è‡ª?•éš±?æ??Ÿæ???                      if (successMessageTimer.current) {
                        window.clearTimeout(successMessageTimer.current);
                      }
                      successMessageTimer.current = window.setTimeout(() => {
                        setShowSuccessMessage(false);
                        console.log("?±è??å?æ¶ˆæ¯");
                      }, 1000);
                    }
                    
                    return success;
                  } catch (error) {
                    console.error("ä¿å??¯å‡º?‚å‡º??", error);
                    return false;
                  }
                }} 
                onCancel={() => {
                  setShowExpenseForm(false);
                  setEditingExpense(null);
                }}
                expense={convertExpenseForForm(editingExpense)}
              />
</div>
</div>
</div>
)}

      {/* ?‹äººè³‡æ?è¡¨å–® */}
      {showProfileForm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fadeIn">
          <div className="relative bg-white rounded-xl shadow-lg max-w-md w-full" style={{animation: 'slideUpIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) both'}}>
            <ProfileForm onClose={() => setShowProfileForm(false)} />
          </div>
        </div>
      )}

      {/* ?’è?æ¦œè¡¨??*/}
      {showLeaderboardForm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <LeaderboardForm onClose={() => setShowLeaderboardForm(false)} />
          </div>
        </div>
      )}

      {/* å¥½å?ç®¡ç?è¡¨å–® */}
      {showFriendManagement && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <FriendManagement onClose={() => setShowFriendManagement(false)} />
          </div>
        </div>
      )}

      {/* ?¥æ??¸æ?å°è©±æ¡?*/}
      {showDatePicker && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 backdrop-blur-sm animate-fadeIn"
          onClick={() => setShowDatePicker(false)}
        >
          <div 
            className="bg-white rounded-lg p-4 w-[90%] max-w-sm animate-slideUpIn shadow-xl border border-[#E8E4ED] transform"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex items-center justify-between mb-4 border-b border-gray-100 pb-2">
              <h3 className="text-base font-medium text-gray-700 flex items-center">
                <i className="fas fa-calendar-day mr-2 text-[#8A7C9F]"></i>
                ?¸æ??¥æ?
              </h3>
              <button
                onClick={() => setShowDatePicker(false)}
                className="w-6 h-6 rounded-full flex items-center justify-center bg-[#F2EDF7] text-[#8A7C9F] hover:bg-[#8A7C9F] hover:text-white transition-all duration-200"
                aria-label="?œé?"
              >
                <i className="fas fa-times text-xs"></i>
              </button>
            </div>
            
            <div className="bg-[#F9F7FB] p-3 rounded-md mb-4">
              <input
                type="date"
                className="w-full p-2 border border-[#E8E4ED] rounded-md focus:outline-none focus:ring-1 focus:ring-[#8A7C9F] focus:border-[#8A7C9F] bg-white text-sm shadow-sm hover:border-[#8A7C9F] transition-all duration-200"
                onChange={(e) => {
                  if (e.target.value) {
                    const [year, month, day] = e.target.value.split('-').map(Number);
                    const selectedDate = new Date(year, month - 1, day);
                    setSelectedDate(selectedDate);
                    setSelectedDateOption("earlier");
                    setShowDatePicker(false);
                  }
                }}
              />
            </div>
            
            <div className="flex space-x-2">
              <button
                onClick={() => setShowDatePicker(false)}
                className="flex-1 py-2 px-4 bg-[#F2EDF7] text-[#8A7C9F] border border-[#E8E4ED] rounded-md hover:bg-[#E8E4ED] transition-colors text-sm flex items-center justify-center gap-1"
              >
                <i className="fas fa-times-circle text-xs"></i>
                ?–æ?
              </button>
              <button
                onClick={() => setShowDatePicker(false)}
                className="flex-1 py-2 px-4 bg-[#8A7C9F] text-white rounded-md hover:bg-[#79708C] transition-colors text-sm flex items-center justify-center gap-1 shadow-sm"
              >
                <i className="fas fa-check-circle text-xs"></i>
                ç¢ºè?
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ?ˆä»½?¸æ?å°è©±æ¡?*/}
      {showMonthPicker && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 backdrop-blur-sm animate-fadeIn"
          onClick={() => setShowMonthPicker(false)}
        >
          <div 
            className="bg-white rounded-lg p-4 w-[90%] max-w-sm animate-slideUpIn shadow-xl border border-[#E8E4ED]"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex items-center justify-between mb-4 border-b border-gray-100 pb-2">
              <h3 className="text-base font-medium text-gray-700 flex items-center">
                <i className="fas fa-calendar-alt mr-2 text-[#8A7C9F]"></i>
                ?¸æ??ˆä»½
              </h3>
              <button
                onClick={() => setShowMonthPicker(false)}
                className="w-6 h-6 rounded-full flex items-center justify-center bg-[#F2EDF7] text-[#8A7C9F] hover:bg-[#8A7C9F] hover:text-white transition-all duration-200"
                aria-label="?œé?"
              >
                <i className="fas fa-times text-xs"></i>
              </button>
            </div>
            
            <div className="bg-[#F9F7FB] p-3 rounded-md mb-4">
              <input
                type="month"
                className="w-full p-2 border border-[#E8E4ED] rounded-md focus:outline-none focus:ring-1 focus:ring-[#8A7C9F] focus:border-[#8A7C9F] bg-white text-sm shadow-sm hover:border-[#8A7C9F] transition-all duration-200"
                onChange={(e) => {
                  if (e.target.value) {
                    const [year, month] = e.target.value.split('-').map(Number);
                    console.log(`?¸æ?äº†æ?ä»? ${year}-${month}`);
                    // è¨­å??ºè©²?ˆç¬¬ä¸€å¤?                    const selectedDate = new Date(year, month - 1, 1);
                    setSelectedDate(selectedDate);
                    setSelectedDateOption("month_select");
                    setShowMonthPicker(false);
                  }
                }}
              />
            </div>
            
            <div className="flex space-x-2">
              <button
                onClick={() => setShowMonthPicker(false)}
                className="flex-1 py-2 px-4 bg-[#F2EDF7] text-[#8A7C9F] border border-[#E8E4ED] rounded-md hover:bg-[#E8E4ED] transition-colors text-sm flex items-center justify-center gap-1"
              >
                <i className="fas fa-times-circle text-xs"></i>
                ?–æ?
              </button>
              <button
                onClick={() => setShowMonthPicker(false)}
                className="flex-1 py-2 px-4 bg-[#8A7C9F] text-white rounded-md hover:bg-[#79708C] transition-colors text-sm flex items-center justify-center gap-1 shadow-sm"
              >
                <i className="fas fa-check-circle text-xs"></i>
                ç¢ºè?
              </button>
            </div>
          </div>
        </div>
      )}

      {/* ?šçŸ¥å½ˆå‡ºçª—å£ */}
      {showNotifications && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 pt-16 animate-fadeIn">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[80vh] overflow-y-auto animate-slideUpIn transform">
            <div className="p-5 border-b border-gray-200 relative">
              <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                  <i className="fas fa-bell text-[#A487C3] mr-3 animate-gentle-pulse"></i>
                  ?šçŸ¥ä¸­å?
                </h2>
                <button
                  onClick={() => setShowNotifications(false)}
                  className="text-white hover:text-white bg-gradient-to-r from-[#A487C3] to-[#C6B2DD] hover:from-[#8A5DC8] hover:to-[#A487C3] w-8 h-8 flex items-center justify-center rounded-full shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none"
                >
                  <i className="fas fa-times"></i>
                </button>
              </div>
              
              {notificationCount > 0 && (
                <div className="absolute right-16 top-5">
                  <span className="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow-md animate-pulse">
                    {notificationCount}
                  </span>
                </div>
              )}
            </div>

            <div className="p-5">
              {notificationCount > 0 ? (
                <div className="space-y-4">
                  {/* å¥½å?è«‹æ??šçŸ¥ */}
                  {friendRequestCount > 0 && (
                    <div
                      className="w-full p-3 rounded-lg bg-blue-50 cursor-pointer hover:bg-blue-100 transition"
                      onClick={() => {
                        setShowNotifications(false);
                        setShowFriendManagement(true);
                      }}
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-500">
                          <i className="fas fa-user-friends"></i>
                        </div>
                        <div className="text-left">
                          <span className="font-medium text-gray-800 block">
                            å¥½å?è«‹æ??šçŸ¥
                          </span>
                          <span className="text-xs text-gray-500">
                            ?¨æ? {friendRequestCount} ?‹å??•ç??„å¥½?‹è?æ±?                          </span>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* ?’è?æ¦œé?è«‹é€šçŸ¥ */}
                  {leaderboardInviteCount > 0 && (
                    <div
                      className="w-full p-3 rounded-lg bg-pink-50 cursor-pointer hover:bg-pink-100 transition"
                      onClick={() => {
                        setShowNotifications(false);
                        setShowLeaderboardInvites(true);
                      }}
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-pink-100 rounded-full flex items-center justify-center text-pink-500">
                          <i className="fas fa-trophy"></i>
                        </div>
                        <div className="text-left">
                          <span className="font-medium text-gray-800 block">
                            ?’è?æ¦œé?è«‹é€šçŸ¥
                          </span>
                          <span className="text-xs text-gray-500">
                            ?¨æ? {leaderboardInviteCount} ?‹æ?è¡Œæ??€è«‹å??•ç?
                          </span>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* ?’è?æ¦œç??Ÿé€šçŸ¥ */}
                  {leaderboardEndedNotifications.length > 0 && (
                    <div
                      className="w-full p-3 rounded-lg bg-purple-50 cursor-pointer hover:bg-purple-100 transition"
                      onClick={() => {
                        // ?œé??šçŸ¥ä¸­å?
                        setShowNotifications(false);

                        // æ¨™è??šçŸ¥?ºå·²è®€
                        leaderboardEndedNotifications.forEach(
                          async (notification) => {
                            try {
                              const notificationRef = doc(
                                db,
                                "notifications",
                                notification.id,
                              );
                              await updateDoc(notificationRef, { read: true });
                            } catch (error) {
                              console.error("æ¨™è??šçŸ¥å·²è?å¤±æ?:", error);
                            }
                          },
                        );

                        // æ¸…ç©º?šçŸ¥
                        setLeaderboardEndedNotifications([]);

                        // ?“é??’è?æ¦œæŸ¥?‹é???                        setShowLeaderboardViewer(true);
                      }}
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-500">
                          <i className="fas fa-chart-line"></i>
                        </div>
                        <div className="text-left">
                          <span className="font-medium text-gray-800 block">
                            ?’è?æ¦œç??œé€šçŸ¥
                          </span>
                          <span className="text-xs text-gray-500">
                            ?¨æ? {leaderboardEndedNotifications.length}{" "}
                            ?‹æ?è¡Œæ?å·²ç??Ÿï?é»æ??¥ç?çµæ?
                          </span>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* ?Ÿè²¸?³å??°æ??šçŸ¥ */}
                  {loanDueNotifications.length > 0 && (
                    <div
                      className="w-full p-3 rounded-lg bg-amber-50 cursor-pointer hover:bg-amber-100 transition relative group"
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center text-amber-500">
                          <i className="fas fa-calendar-alt"></i>
                        </div>
                        <div className="text-left flex-1">
                          <span className="font-medium text-gray-800 block">
                            ?Ÿè²¸?³å??°æ??šçŸ¥
                          </span>
                          <span className="text-xs text-gray-500 block">
                            ?¨æ? {loanDueNotifications.length} ç­†å€Ÿè²¸?³å??°æ?
                          </span>
                        </div>
                        <button
                          onClick={() => {
                            setShowNotifications(false);
                            setShowLoanManagement(true);
                          }}
                          className="bg-amber-400 hover:bg-amber-500 text-white text-xs font-medium py-1 px-2 rounded transition-all"
                        >
                          ?¥ç?
                        </button>
                      </div>
                      <div className="mt-2 space-y-2 pl-12">
                        {loanDueNotifications.map((notification) => (
                          <div key={notification.id} className="border-t border-amber-200 pt-2 flex justify-between items-center">
                            <div>
                              <div className="text-sm font-medium text-gray-700">
                                {notification.loanType === 'lend' ? '?Ÿå‡ºçµ? : '?Ÿå…¥??} {notification.counterpartyName}
                              </div>
                              <div className="text-xs text-gray-500">
                                ?‘é?: {formatAmount(notification.amount)} | 
                                ?°æ??? {new Date(notification.dueDate.seconds * 1000).toLocaleDateString()}
                              </div>
                            </div>
                            <button
                              onClick={async (e) => {
                                e.stopPropagation();
                                try {
                                  const notificationRef = doc(
                                    db,
                                    "notifications",
                                    notification.id,
                                  );
                                  await updateDoc(notificationRef, { read: true });
                                  
                                  // ?´æ–°?šçŸ¥?€??                                  setLoanDueNotifications(prev => 
                                    prev.filter(item => item.id !== notification.id)
                                  );
                                } catch (error) {
                                  console.error("æ¨™è??šçŸ¥å·²è?å¤±æ?:", error);
                                }
                              }}
                              className="text-xs bg-white hover:bg-gray-200 text-gray-500 border border-amber-200 py-1 px-2 rounded-full transition-colors"
                            >
                              <i className="fas fa-check mr-1"></i>
                              å·²è?
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {/* ?Ÿè²¸å·²é€¾æ??šçŸ¥ */}
                  {loanOverdueNotifications.length > 0 && (
                    <div
                      className="w-full p-3 rounded-lg bg-red-50 cursor-pointer hover:bg-red-100 transition relative group"
                    >
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center text-red-500">
                          <i className="fas fa-exclamation-circle"></i>
                        </div>
                        <div className="text-left flex-1">
                          <span className="font-medium text-gray-800 block">
                            ?Ÿè²¸å·²é€¾æ??šçŸ¥
                          </span>
                          <span className="text-xs text-gray-500 block">
                            ?¨æ? {loanOverdueNotifications.length} ç­†å€Ÿè²¸å·²é€¾æ?
                          </span>
                        </div>
                        <button
                          onClick={() => {
                            setShowNotifications(false);
                            setShowLoanManagement(true);
                          }}
                          className="bg-red-500 hover:bg-red-600 text-white text-xs font-medium py-1 px-2 rounded transition-all"
                        >
                          ?•ç?
                        </button>
                      </div>
                      <div className="mt-2 space-y-2 pl-12">
                        {loanOverdueNotifications.map((notification) => (
                          <div key={notification.id} className="border-t border-red-200 pt-2 flex justify-between items-center">
                            <div>
                              <div className="text-sm font-medium text-gray-700">
                                {notification.loanType === 'lend' ? '?Ÿå‡ºçµ? : '?Ÿå…¥??} {notification.counterpartyName}
                              </div>
                              <div className="text-xs text-gray-500">
                                ?‘é?: {formatAmount(notification.amount)} | 
                                ?°æ??? {new Date(notification.dueDate.seconds * 1000).toLocaleDateString()}
                              </div>
                            </div>
                            <button
                              onClick={async (e) => {
                                e.stopPropagation();
                                try {
                                  const notificationRef = doc(
                                    db,
                                    "notifications",
                                    notification.id,
                                  );
                                  await updateDoc(notificationRef, { read: true });
                                  
                                  // ?´æ–°?šçŸ¥?€??                                  setLoanOverdueNotifications(prev => 
                                    prev.filter(item => item.id !== notification.id)
                                  );
                                } catch (error) {
                                  console.error("æ¨™è??šçŸ¥å·²è?å¤±æ?:", error);
                                }
                              }}
                              className="text-xs bg-white hover:bg-gray-200 text-gray-500 border border-red-200 py-1 px-2 rounded-full transition-colors"
                            >
                              <i className="fas fa-check mr-1"></i>
                              å·²è?
                            </button>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              ) : (
                <div className="text-center py-12">
                  <i className="fas fa-bell-slash text-gray-300 text-4xl mb-4 transform rotate-12"></i>
                  <p className="text-gray-500 font-medium">?®å?æ²’æ?ä»»ä??šçŸ¥</p>
                  <p className="text-gray-400 text-sm mt-2">?¶æ??°ç?æ¶ˆæ¯?‚ï?å°‡æ??¨é€™è£¡é¡¯ç¤º</p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* ?’è?æ¦œé?è«‹å?è¡?*/}
      {showLeaderboardInvites && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <LeaderboardInviteList
              onClose={() => setShowLeaderboardInvites(false)}
            />
          </div>
        </div>
      )}

      {/* å¥½å?ç®¡ç??é¢ */}
      {showFriendManagement && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[80vh] overflow-y-auto">
            <FriendManagement onClose={() => setShowFriendManagement(false)} />
          </div>
        </div>
      )}

      {/* ?’è?æ¦œæŸ¥?‹ç?ä»?*/}
      {showLeaderboardViewer && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <LeaderboardViewer
              onClose={() => setShowLeaderboardViewer(false)}
            />
          </div>
        </div>
      )}

      {/* ?’è?æ¦œé€šçŸ¥?•ç?çµ„ä»¶ */}
      <LeaderboardNotification />

      {/* ?ç??Œå€Ÿè²¸?šçŸ¥?•ç?çµ„ä»¶ */}
      <BudgetNotification />

      {/* ?Ÿè²¸ç®¡ç?è¡¨å–® */}
      {showLoanManagement && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <LoanManagement onClose={() => setShowLoanManagement(false)} />
          </div>
        </div>
      )}

      {/* ?ç?è¨­ç½®è¡¨å–® */}
      {showBudgetSetting && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <BudgetSetting onClose={() => setShowBudgetSetting(false)} />
          </div>
        </div>
      )}

      {/* å¥½å??†å¸³è¡¨å–® */}
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
          </div>
        </div>
      )}
</div>
);
};

export default App;
